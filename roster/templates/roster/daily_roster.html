{% extends 'roster/base.html' %}

{% block title %}–ì—Ä–∞—Ñ–∏–∫ –∑–∞ {{ selected_date|date:"d.m.Y" }}{% endblock %}

{% block extra_css %}
<style>
    .nav-tabs .nav-link.active {
        font-weight: bold;
        border-top: 3px solid #0d6efd;
    }
    .stats-card {
        background: white;
        border-radius: 10px;
        padding: 15px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    /* –°—Ç–∏–ª–æ–≤–µ —Å–∞–º–æ –∑–∞ –ø—Ä–∏–Ω—Ç–∏—Ä–∞–Ω–µ */
    @media print {
        .btn, form, .nav-tabs, a[href^="/"], .accordion-button::after, nav.navbar, footer {
            display: none !important;
        }
        body, .stats-card, .accordion-item, main {
            background-color: white !important;
            color: black !important;
            box-shadow: none !important;
            border: 1px solid #ddd !important;
            margin: 0 !important;
            padding: 0 !important;
        }
        .collapse {
            display: block !important;
            height: auto !important;
            opacity: 1 !important;
            visibility: visible !important;
        }
        .accordion-button { pointer-events: none; padding: 5px 0; }
        h2::after { content: " (DUTOS v3)"; font-size: 12px; color: #666; }
    }
</style>
{% endblock %}

{% block content %}
<div class="mt-4 mb-5"> <div class="d-flex justify-content-between align-items-center mb-4">
        <a href="{% url 'roster_calendar' %}" class="btn btn-outline-secondary">‚¨ÖÔ∏è –ö–∞–ª–µ–Ω–¥–∞—Ä</a>
        
        <h2 class="text-primary mb-0">
          üìÖ {{ selected_date|date:"d.m.Y" }}
          <span class="text-muted">({{ selected_date|date:"l" }})</span>
        </h2>
        <div>
          <form method="get" class="d-flex">
            <input
              type="date"
              name="date"
              class="form-control form-control-sm me-2"
              value="{{ selected_date|date:'Y-m-d' }}"
            />
            <button type="submit" class="btn btn-sm btn-primary">Go</button>
          </form>
        </div>
    </div>

    <ul class="nav nav-tabs mb-3" id="dailyTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="shifts-tab" data-bs-toggle="tab" data-bs-target="#shifts" type="button">
            üìã –î–µ–∂—É—Ä–Ω–∞ —Å–ª—É–∂–±–∞ <span class="badge bg-primary rounded-pill ms-1">{{ total_on_duty }}</span>
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="stats-tab" data-bs-toggle="tab" data-bs-target="#stats" type="button">
            üìä –†–∞–∑—Ö–æ–¥ / –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
          </button>
        </li>
    </ul>

    <div class="tab-content" id="dailyTabsContent">
        <div class="tab-pane fade show active" id="shifts">
            {% regroup shifts by soldier.rank_group.name as course_groups %}
            <div class="accordion" id="accordionShifts">
                {% for group in course_groups %}
                <div class="accordion-item mb-3 shadow-sm border-0">
                    <h2 class="accordion-header" id="heading{{ forloop.counter }}">
                        <button class="accordion-button {% if not forloop.first %}collapsed{% endif %} fw-bold bg-light text-dark" 
                                type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ forloop.counter }}">
                            {{ group.grouper }} <span class="badge bg-primary ms-2 rounded-pill">{{ group.list|length }}</span>
                        </button>
                    </h2>
                    <div id="collapse{{ forloop.counter }}" class="accordion-collapse collapse {% if forloop.first %}show{% endif %}" data-bs-parent="#accordionShifts">
                        <div class="accordion-body p-0">
                            <table class="table table-hover table-striped mb-0 align-middle">
                                <thead class="table-light small text-uppercase">
                                    <tr><th style="width: 40%">–í–æ–µ–Ω–Ω–æ—Å–ª—É–∂–µ—â</th><th style="width: 40%">–ù–∞—Ä—è–¥</th><th class="text-end">–î–µ–π—Å—Ç–≤–∏—è</th></tr>
                                </thead>
                                <tbody>
                                    {% for shift in group.list %}
                                    <tr>
                                        <td>
                                            <div class="fw-bold">
                                                <a href="#" class="text-decoration-none text-dark open-profile" data-url="{% url 'soldier_profile' shift.soldier.id %}">
                                                    {{ shift.soldier.rank_title }} {{ shift.soldier.last_name }}
                                                </a>
                                            </div>
                                            <div class="small text-muted">{{ shift.soldier.faculty_number }} | {{ shift.soldier.platoon }} –≤–∑–≤.</div>
                                        </td>
                                        <td>
                                            <span class="badge bg-primary" style="font-size: 0.9rem;">{{ shift.duty_type.name }}</span>
                                            {% if shift.status == 'admin_draft' %}
                                                <br><span class="badge bg-warning text-dark mt-1">‚ö†Ô∏è –°–∫—Ä–∏—Ç–∞ —á–µ—Ä–Ω–æ–≤–∞</span>
                                            {% endif %}
                                        </td>                                        
                                        <td class="text-end">
                                            <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#swapModal"
                                                    onclick="setupSwap('{{ shift.id }}', '{{ shift.soldier.last_name }}', '{{ shift.duty_type.name }}')">
                                                üîÑ –°–º—è–Ω–∞
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="alert alert-info text-center">üì≠ –ù—è–º–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏ –Ω–∞—Ä—è–¥–∏ –∑–∞ —Ç–∞–∑–∏ –¥–∞—Ç–∞.</div>
                {% endfor %}
            </div>
        </div>

        <div class="tab-pane fade" id="stats">
            <div class="accordion" id="reportAccordion">
                {% for key, group in report.items %}
                <div class="accordion-item mb-3 border-{{ group.class }} shadow-sm">
                    <h2 class="accordion-header" id="heading{{ key }}">
                        <button class="accordion-button {% if not forloop.first %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ key }}">
                            <div class="d-flex w-100 justify-content-between align-items-center me-3 flex-wrap">
                                <span class="fw-bold text-{{ group.class }} me-2">{{ group.name }}</span>
                                <div style="font-size: 0.85rem" class="d-flex gap-1">
                                    <span class="badge bg-secondary">–°–ø–∏—Å—ä–∫: {{ group.total }}</span>
                                    <span class="badge bg-success">–ù–∞–ª–∏—Ü–µ: {{ group.present }}</span>
                                    {% if group.duty %}<span class="badge bg-dark">–ù–∞—Ä—è–¥: {{ group.duty|length }}</span>{% endif %}
                                    {% if group.sick %}<span class="badge bg-danger">–ë–æ–ª–Ω–∏: {{ group.sick|length }}</span>{% endif %}
                                    {% if group.home %}<span class="badge bg-warning text-dark">–î–û: {{ group.home|length }}</span>{% endif %}
                                    {% if group.mission %}<span class="badge bg-primary">–ö–æ–º: {{ group.mission|length }}</span>{% endif %}
                                </div>
                            </div>
                        </button>
                    </h2>
                    <div id="collapse{{ key }}" class="accordion-collapse collapse {% if forloop.first %}show{% endif %}" data-bs-parent="#reportAccordion">
                        <div class="accordion-body">
                            <table class="table table-bordered table-sm text-center mb-4">
                                <thead class="table-light"><tr><th>–ü–æ —Å–ø–∏—Å—ä–∫</th><th class="text-success">–ù–∞–ª–∏—Ü–µ</th><th class="table-active">–ù–∞—Ä—è–¥</th><th class="text-danger">–ë–æ–ª–Ω–∏</th><th class="text-warning">–î–û</th><th class="text-primary">–ö–æ–º.</th><th>–î—Ä—É–≥–∏</th></tr></thead>
                                <tbody class="fw-bold fs-5">
                                    <tr>
                                        <td>{{ group.total }}</td><td class="text-success">{{ group.present }}</td><td>{{ group.duty|length }}</td><td class="text-danger">{{ group.sick|length }}</td><td class="text-warning">{{ group.home|length }}</td><td class="text-primary">{{ group.mission|length }}</td><td>{{ group.other|length }}</td>
                                    </tr>
                                </tbody>
                            </table>
                            <div class="row g-3">
                                {% if group.duty %}
                                <div class="col-md-6"><div class="card h-100 border-secondary"><div class="card-header bg-secondary text-white py-1">üíÇ –ù–∞—Ä—è–¥</div><ul class="list-group list-group-flush small">{% for s in group.duty %}<li class="list-group-item d-flex justify-content-between"><span>{{ s.soldier.last_name }}</span><strong>{{ s.duty_type.name }}</strong></li>{% endfor %}</ul></div></div>
                                {% endif %}
                                {% if group.sick %}
                                <div class="col-md-6"><div class="card h-100 border-danger"><div class="card-header bg-danger text-white py-1">ü§í –ë–æ–ª–Ω–∏</div><ul class="list-group list-group-flush small">{% for l in group.sick %}<li class="list-group-item"><strong>{{ l.soldier.last_name }}</strong><span class="text-muted"> - {{ l.reason|default:"–ë–æ–ª–µ—Å—Ç" }}</span></li>{% endfor %}</ul></div></div>
                                {% endif %}
                                </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="swapModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">üö® –°–º—è–Ω–∞ –ø–æ —Å–ø–µ—à–Ω–æ—Å—Ç</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" id="swapForm" action="">
                {% csrf_token %}
                <div class="modal-body">
                    <p>–°–º—è–Ω–∞ –Ω–∞: <strong id="swapTargetName">...</strong></p>
                    <p>–ù–∞—Ä—è–¥: <strong id="swapTargetDuty">...</strong></p>
                    <hr />
                    <div class="mb-3">
                        <label class="form-label">–ò–∑–±–µ—Ä–∏ –∑–∞–º–µ—Å—Ç–Ω–∏–∫:</label>
                        <select name="new_soldier" class="form-select" required size="5">
                            {% for s in all_soldiers %}
                            <option value="{{ s.id }}">{{ s.last_name }} ({{ s.rank_title }}) - {{ s.faculty_number }} [{{ s.score }} —Ç.]</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3"><label class="form-label">–ü—Ä–∏—á–∏–Ω–∞:</label><input type="text" name="reason" class="form-control"></div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–∫–∞–∑</button><button type="submit" class="btn btn-danger">–ò–∑–≤—ä—Ä—à–∏ —Å–º—è–Ω–∞</button></div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="soldierModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-body text-center p-5"><div class="spinner-border text-primary"></div></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener("DOMContentLoaded", function() {
        // –ú–æ–¥–∞–ª –∑–∞ –ø—Ä–æ—Ñ–∏–ª–∏
        var soldierModal = new bootstrap.Modal(document.getElementById('soldierModal'));
        var modalContent = document.querySelector('#soldierModal .modal-content');

        document.body.addEventListener('click', function(e) {
            var target = e.target.closest('.open-profile');
            if (target) {
                e.preventDefault();
                soldierModal.show();
                fetch(target.getAttribute('data-url'))
                    .then(response => response.text())
                    .then(html => {
                        modalContent.innerHTML = html;
                        bindDutyForm(); // –ê–∫—Ç–∏–≤–∏—Ä–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –≤—ä—Ç—Ä–µ –∞–∫–æ –∏–º–∞
                    });
            }
        });

        // –§—É–Ω–∫—Ü–∏—è –∑–∞ AJAX —Ñ–æ—Ä–º–∞—Ç–∞ –≤—ä—Ç—Ä–µ –≤ –º–æ–¥–∞–ª–∞
        function bindDutyForm() {
            var form = document.getElementById('dutyForm');
            if (form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    fetch(form.action, {
                        method: 'POST',
                        body: new FormData(form),
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    })
                    .then(r => r.redirected ? window.location.reload() : r.text())
                    .then(html => { if(html) modalContent.innerHTML = html; bindDutyForm(); });
                });
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞ –º–æ–¥–∞–ª–∞ –∑–∞ —Å–º—è–Ω–∞
        window.setupSwap = function(shiftId, soldierName, dutyName) {
            var form = document.getElementById('swapForm');
            if(form) {
                form.action = "/roster/swap/" + shiftId + "/";
                document.getElementById('swapTargetName').innerText = soldierName;
                document.getElementById('swapTargetDuty').innerText = dutyName;
            }
        };
    });
</script>
{% endblock %}