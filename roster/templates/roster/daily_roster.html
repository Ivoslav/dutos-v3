<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <title>DUTOS - –ì—Ä–∞—Ñ–∏–∫</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .duty-card { border-left: 5px solid #0d6efd; transition: transform 0.2s; }
        .duty-card:hover { transform: translateX(5px); background-color: #fff; }
        /* –¶–≤–µ—Ç–æ–≤–µ –∑–∞ –±–∞–¥–∂–æ–≤–µ—Ç–µ –Ω–∞ –∫—É—Ä—Å–æ–≤–µ—Ç–µ */
        .bg-c5 { background-color: #2c3e50; color: white; } /* 5-—Ç–∏ */
        .bg-c4 { background-color: #e67e22; color: white; } /* 4-—Ç–∏ */
        .bg-c3 { background-color: #27ae60; color: white; } /* 3-—Ç–∏ */
        .bg-c2 { background-color: #2980b9; color: white; } /* 2-—Ä–∏ */
        .bg-c1 { background-color: #8e44ad; color: white; } /* 1-–≤–∏ */
    </style>
</head>
<body>

<div class="container mt-5 mb-5">
    <div class="row mb-4">
        <div class="col text-center">
            <h1 class="display-6">üìÖ –î–Ω–µ–≤–µ–Ω –ì—Ä–∞—Ñ–∏–∫</h1>
            <div class="mb-3">
                <a href="/roster/stats/" class="btn btn-outline-info btn-sm">üìä –ö—ä–º –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a>
                <a href="/admin/" class="btn btn-outline-dark btn-sm">‚öôÔ∏è –ê–¥–º–∏–Ω</a>
            </div>
            
            <form method="get" class="d-flex justify-content-center mt-3">
                <input type="date" name="date" class="form-control w-auto me-2 shadow-sm" value="{{ selected_date|date:'Y-m-d' }}">
                <button type="submit" class="btn btn-primary shadow-sm">–í–∏–∂ –¥–∞—Ç–∞</button>
            </form>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-md-9">
            <h3 class="text-center mb-4 text-primary">{{ selected_date|date:"d.m.Y" }} ({{ selected_date|date:"l" }})</h3>
            
            {% if shifts %}
                
                {% regroup shifts by soldier.rank_group as course_groups %}

                <div class="accordion" id="rosterAccordion">
                {% for group in course_groups %}
                    <div class="accordion-item mb-3 border shadow-sm" style="border-radius: 8px; overflow: hidden;">
                        
                        <h2 class="accordion-header" id="heading{{ forloop.counter }}">
                            <button class="accordion-button {% if not forloop.first %}collapsed{% endif %}" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#collapse{{ forloop.counter }}" 
                                    aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}" 
                                    aria-controls="collapse{{ forloop.counter }}">
                                <strong>{{ group.grouper }}</strong>
                                <span class="badge bg-secondary ms-2">{{ group.list|length }} –Ω–∞—Ä—è–¥–∞</span>
                            </button>
                        </h2>

                        <div id="collapse{{ forloop.counter }}" class="accordion-collapse collapse {% if forloop.first %}show{% endif %}" 
                             aria-labelledby="heading{{ forloop.counter }}" data-bs-parent="#rosterAccordion">
                            <div class="accordion-body p-0">
                                <div class="list-group list-group-flush">
                                {% for shift in group.list %}
                                    <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center p-3">
                                        
                                        <div>
                                            <h5 class="mb-1 text-primary">{{ shift.duty_type.name }}</h5>
                                            <small class="text-muted">–¢–µ–∂–µ—Å—Ç: <strong>{{ shift.duty_type.weight }}</strong> —Ç.</small>
                                        </div>

                                        <div class="text-end">
                                            <a href="#" class="text-decoration-none text-dark open-profile" 
                                               data-url="{% url 'soldier_profile' shift.soldier.id %}">
                                                <span class="badge bg-light text-dark border">{{ shift.soldier.rank_title }}</span>
                                                <strong class="fs-5">{{ shift.soldier.last_name }}</strong>
                                            </a>
                                            <br>
                                            <small class="text-muted" style="font-size: 0.8rem;">
                                                {{ shift.soldier.faculty_number }} | {{ shift.soldier.platoon }} –≤–∑–≤.
                                            </small>
                                        </div>

                                    </div>
                                {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
                </div>

            {% else %}
                <div class="alert alert-warning text-center shadow-sm p-5">
                    <h4>üì≠ –ù—è–º–∞ –Ω–∞—Ä—è–¥–∏ –∑–∞ —Ç–∞–∑–∏ –¥–∞—Ç–∞</h4>
                    <p>–ò–∑–ø–æ–ª–∑–≤–∞–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞, –∑–∞ –¥–∞ —Å—ä–∑–¥–∞–¥–µ—à –≥—Ä–∞—Ñ–∏–∫.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<div class="modal fade" id="soldierModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-body text-center p-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p>–ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –¥–æ—Å–∏–µ...</p>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        var soldierModal = document.getElementById('soldierModal');
        var modalContent = soldierModal.querySelector('.modal-content');
        var bsModal = new bootstrap.Modal(soldierModal);

        document.body.addEventListener('click', function(e) {
            var target = e.target.closest('.open-profile');
            if (target) {
                e.preventDefault();
                var url = target.getAttribute('data-url');
                bsModal.show();
                
                fetch(url)
                    .then(response => response.text())
                    .then(html => { modalContent.innerHTML = html; })
                    .catch(err => { modalContent.innerHTML = '<div class="modal-body text-danger">–ì—Ä–µ—à–∫–∞!</div>'; });
            }
        });
    });
</script>

</body>
</html>