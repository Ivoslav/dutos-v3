<!doctype html>
<html lang="bg">
  <head>
    <meta charset="UTF-8" />
    <title>–û–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ –¢–∞–±–ª–æ</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #f0f2f5;
      }
      .nav-tabs .nav-link.active {
        font-weight: bold;
        border-top: 3px solid #0d6efd;
      }
      .stats-card {
        background: white;
        border-radius: 10px;
        padding: 15px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }
      /* –°—Ç–∏–ª–æ–≤–µ —Å–∞–º–æ –∑–∞ –ø—Ä–∏–Ω—Ç–∏—Ä–∞–Ω–µ */
        @media print {
            /* –°–∫—Ä–∏–π –±—É—Ç–æ–Ω–∏—Ç–µ, –Ω–∞–≤–∏–≥–∞—Ü–∏—è—Ç–∞ –∏ —Ñ–æ—Ä–º–∏—Ç–µ */
            .btn, form, .nav-tabs, a[href^="/"], .accordion-button::after {
                display: none !important;
            }
            
            /* –ù–∞–ø—Ä–∞–≤–∏ —Ñ–æ–Ω–∞ –±—è–ª –∏ —Ç–µ–∫—Å—Ç–∞ —á–µ—Ä–µ–Ω */
            body, .stats-card, .accordion-item {
                background-color: white !important;
                color: black !important;
                box-shadow: none !important;
                border: 1px solid #ddd !important;
            }
            
            /* –†–∞–∑–ø—ä–Ω–∏ –≤—Å–∏—á–∫–∏ –∞–∫–æ—Ä–¥–µ–æ–Ω–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ */
            .collapse {
                display: block !important;
                height: auto !important;
                opacity: 1 !important;
                visibility: visible !important;
            }
            
            /* –°–∫—Ä–∏–π –∏–∑–ª–∏—à–Ω–∏ –µ–ª–µ–º–µ–Ω—Ç–∏ */
            .accordion-button {
                pointer-events: none; /* –ó–∞–±—Ä–∞–Ω–∏ –∫–ª–∏–∫–∞–Ω–µ—Ç–æ –Ω–∞ —Ö–∞—Ä—Ç–∏—è :) */
                padding: 5px 0;
            }

            /* –ó–∞–≥–ª–∞–≤–∏–µ –∑–∞ –ø—Ä–∏–Ω—Ç–∞ */
            h2::after {
                content: " (–ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω –æ—Ç DUTOS)";
                font-size: 12px;
                color: #666;
            }
        }
    </style>
  </head>
  <body>
    <div class="container mt-4 mb-5">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <a href="/roster/" class="btn btn-outline-secondary">‚¨ÖÔ∏è –ö–∞–ª–µ–Ω–¥–∞—Ä</a>
        <h2 class="text-primary mb-0">
          üìÖ {{ selected_date|date:"d.m.Y" }}
          <span class="text-muted">({{ selected_date|date:"l" }})</span>
        </h2>
        <div>
          <form method="get" class="d-flex">
            <input
              type="date"
              name="date"
              class="form-control form-control-sm me-2"
              value="{{ selected_date|date:'Y-m-d' }}"
            />
            <button type="submit" class="btn btn-sm btn-primary">Go</button>
          </form>
        </div>
      </div>

      <ul class="nav nav-tabs mb-3" id="dailyTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button
            class="nav-link active"
            id="shifts-tab"
            data-bs-toggle="tab"
            data-bs-target="#shifts" 
            type="button"
            role="tab"
            aria-controls="shifts"
            aria-selected="true"
          >
            üìã –î–µ–∂—É—Ä–Ω–∞ —Å–ª—É–∂–±–∞
            <span class="badge bg-primary rounded-pill ms-1">{{ total_on_duty }}</span>
          </button>
        </li>
        
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="stats-tab"
            data-bs-toggle="tab"
            data-bs-target="#stats"
            type="button"
            role="tab"
            aria-controls="stats"
            aria-selected="false"
          >
            üìä –†–∞–∑—Ö–æ–¥ / –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
          </button>
        </li>
      </ul>

      <div class="tab-content" id="dailyTabsContent">
        <div class="tab-pane fade show active" id="shifts">
    
    {% regroup shifts by soldier.rank_group.name as course_groups %}

    <div class="accordion" id="accordionShifts">
        {% for group in course_groups %}
        <div class="accordion-item mb-3 shadow-sm border-0">
            
            <h2 class="accordion-header" id="heading{{ forloop.counter }}">
                <button class="accordion-button {% if not forloop.first %}collapsed{% endif %} fw-bold bg-light text-dark" 
                        type="button" 
                        data-bs-toggle="collapse" 
                        data-bs-target="#collapse{{ forloop.counter }}">
                    {{ group.grouper }} <span class="badge bg-primary ms-2 rounded-pill">{{ group.list|length }}</span>
                </button>
            </h2>

            <div id="collapse{{ forloop.counter }}" 
                 class="accordion-collapse collapse {% if forloop.first %}show{% endif %}" 
                 data-bs-parent="#accordionShifts">
                
                <div class="accordion-body p-0">
                    <table class="table table-hover table-striped mb-0 align-middle">
                        <thead class="table-light small text-uppercase">
                            <tr>
                                <th style="width: 40%">–í–æ–µ–Ω–Ω–æ—Å–ª—É–∂–µ—â</th>
                                <th style="width: 40%">–ù–∞—Ä—è–¥</th>
                                <th class="text-end">–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for shift in group.list %}
                            <tr>
                                <td>
                                    <div class="fw-bold">
                                        <a href="#" class="text-decoration-none text-dark open-profile" 
                                           data-url="{% url 'soldier_profile' shift.soldier.id %}">
                                            {{ shift.soldier.rank_title }} {{ shift.soldier.last_name }}
                                        </a>
                                    </div>
                                    
                                    <div class="small text-muted">
                                        {{ shift.soldier.faculty_number }} | {{ shift.soldier.platoon }} –≤–∑–≤.
                                    </div>
                                </td>

                                <td>
                                    <span class="badge bg-primary" style="font-size: 0.9rem;">
                                        {{ shift.duty_type.name }}
                                    </span>
                                </td>

                                <td class="text-end">
                                    <button class="btn btn-sm btn-outline-danger" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#swapModal"
                                            onclick="setupSwap('{{ shift.id }}', '{{ shift.soldier.last_name }}', '{{ shift.duty_type.name }}')">
                                        üîÑ –°–º—è–Ω–∞
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% empty %}
            <div class="alert alert-info text-center">
                üì≠ –ù—è–º–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏ –Ω–∞—Ä—è–¥–∏ –∑–∞ —Ç–∞–∑–∏ –¥–∞—Ç–∞.
            </div>
        {% endfor %}
    </div>
</div>

        <div class="tab-pane fade" id="stats">
          <div class="accordion" id="reportAccordion">
            {% for key, group in report.items %}
            <div class="accordion-item mb-3 border-{{ group.class }} shadow-sm">
              <h2 class="accordion-header" id="heading{{ key }}">
                <button
                  class="accordion-button {% if not forloop.first %}collapsed{% endif %}"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#collapse{{ key }}"
                >
                  <div
                    class="d-flex w-100 justify-content-between align-items-center me-3 flex-wrap"
                  >
                    <span class="fw-bold text-{{ group.class }} me-2"
                      >{{ group.name }}</span
                    >

                    <div style="font-size: 0.85rem" class="d-flex gap-1">
                      <span class="badge bg-secondary"
                        >–°–ø–∏—Å—ä–∫: {{ group.total }}</span
                      >
                      <span class="badge bg-success"
                        >–ù–∞–ª–∏—Ü–µ: {{ group.present }}</span
                      >

                      {% if group.duty %}
                      <span class="badge bg-dark"
                        >–ù–∞—Ä—è–¥: {{ group.duty|length }}</span
                      >
                      {% endif %} {% if group.sick %}
                      <span class="badge bg-danger"
                        >–ë–æ–ª–Ω–∏: {{ group.sick|length }}</span
                      >
                      {% endif %} {% if group.home %}
                      <span class="badge bg-warning text-dark"
                        >–î–û: {{ group.home|length }}</span
                      >
                      {% endif %} {% if group.mission %}
                      <span class="badge bg-primary"
                        >–ö–æ–º: {{ group.mission|length }}</span
                      >
                      {% endif %} {% if group.other %}
                      <span class="badge bg-info text-dark"
                        >–î—Ä—É–≥–∏: {{ group.other|length }}</span
                      >
                      {% endif %}
                    </div>
                  </div>
                </button>
              </h2>

              <div
                id="collapse{{ key }}"
                class="accordion-collapse collapse {% if forloop.first %}show{% endif %}"
                data-bs-parent="#reportAccordion"
              >
                <div class="accordion-body">
                  <table class="table table-bordered table-sm text-center mb-4">
                    <thead class="table-light">
                      <tr>
                        <th>–ü–æ —Å–ø–∏—Å—ä–∫</th>
                        <th class="text-success">–ù–∞–ª–∏—Ü–µ</th>
                        <th class="table-active">–ù–∞—Ä—è–¥</th>
                        <th class="text-danger">–ë–æ–ª–Ω–∏</th>
                        <th class="text-warning">–î–û</th>
                        <th class="text-primary">–ö–æ–º.</th>
                        <th>–î—Ä—É–≥–∏</th>
                      </tr>
                    </thead>
                    <tbody class="fw-bold fs-5">
                      <tr>
                        <td>{{ group.total }}</td>
                        <td class="text-success">{{ group.present }}</td>
                        <td>{{ group.duty|length }}</td>
                        <td class="text-danger">{{ group.sick|length }}</td>
                        <td class="text-warning">{{ group.home|length }}</td>
                        <td class="text-primary">{{ group.mission|length }}</td>
                        <td>{{ group.other|length }}</td>
                      </tr>
                    </tbody>
                  </table>

                  <div class="row g-3">
                    {% if group.duty %}
                    <div class="col-md-6">
                      <div class="card h-100 border-secondary">
                        <div class="card-header bg-secondary text-white py-1">
                          üíÇ –ù–∞—Ä—è–¥ ({{ group.duty|length }})
                        </div>
                        <ul class="list-group list-group-flush small">
                          {% for s in group.duty %}
                          <li
                            class="list-group-item d-flex justify-content-between"
                          >
                            <span>{{ s.soldier.last_name }}</span>
                            <strong>{{ s.duty_type.name }}</strong>
                          </li>
                          {% endfor %}
                        </ul>
                      </div>
                    </div>
                    {% endif %} {% if group.sick %}
                    <div class="col-md-6">
                      <div class="card h-100 border-danger">
                        <div class="card-header bg-danger text-white py-1">
                          ü§í –ë–æ–ª–Ω–∏ / –õ–∞–∑–∞—Ä–µ—Ç ({{ group.sick|length }})
                        </div>
                        <ul class="list-group list-group-flush small">
                          {% for l in group.sick %}
                          <li class="list-group-item">
                            <strong>{{ l.soldier.last_name }}</strong>
                            <span class="text-muted fst-italic"
                              >- {{ l.reason|default:"–ë–æ–ª–µ—Å—Ç" }}</span
                            >
                            <span class="float-end"
                              >{{ l.end_date|date:"d.m" }}</span
                            >
                          </li>
                          {% endfor %}
                        </ul>
                      </div>
                    </div>
                    {% endif %} {% if group.home %}
                    <div class="col-md-6">
                      <div class="card h-100 border-warning">
                        <div class="card-header bg-warning text-dark py-1">
                          üè† –î–æ–º–∞—à–µ–Ω –æ—Ç–ø—É—Å–∫ ({{ group.home|length }})
                        </div>
                        <ul class="list-group list-group-flush small">
                          {% for l in group.home %}
                          <li class="list-group-item">
                            <strong>{{ l.soldier.last_name }}</strong>
                            <span class="float-end"
                              >–¥–æ {{ l.end_date|date:"d.m" }}</span
                            >
                          </li>
                          {% endfor %}
                        </ul>
                      </div>
                    </div>
                    {% endif %} {% if group.mission %}
                    <div class="col-md-6">
                      <div class="card h-100 border-primary">
                        <div class="card-header bg-primary text-white py-1">
                          ‚úàÔ∏è –ö–æ–º–∞–Ω–¥–∏—Ä–æ–≤–∫–∞ ({{ group.mission|length }})
                        </div>
                        <ul class="list-group list-group-flush small">
                          {% for l in group.mission %}
                          <li class="list-group-item">
                            <strong>{{ l.soldier.last_name }}</strong>
                            <span class="float-end"
                              >{{ l.end_date|date:"d.m" }}</span
                            >
                          </li>
                          {% endfor %}
                        </ul>
                      </div>
                    </div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="swapModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title">üö® –°–º—è–Ω–∞ –ø–æ —Å–ø–µ—à–Ω–æ—Å—Ç</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <form method="post" id="swapForm" action="">
            {% csrf_token %}
            <div class="modal-body">
              <p>–°–º—è–Ω–∞ –Ω–∞: <strong id="swapTargetName">...</strong></p>
              <p>–ù–∞—Ä—è–¥: <strong id="swapTargetDuty">...</strong></p>
              <hr />

              <div class="mb-3">
                <label class="form-label">–ò–∑–±–µ—Ä–∏ –∑–∞–º–µ—Å—Ç–Ω–∏–∫:</label>
                <div class="mb-3">
                <label class="form-label">–ò–∑–±–µ—Ä–∏ –∑–∞–º–µ—Å—Ç–Ω–∏–∫:</label>
                <select
                  name="new_soldier"
                  class="form-select"
                  required
                  size="5"
                >
                  {% for s in all_soldiers %}
                  <option value="{{ s.id }}">
                    {{ s.last_name }} ({{ s.rank_title }}) - {{ s.faculty_number }} [{{ s.score }} —Ç.]
                  </option>
                  {% endfor %}
                </select>
                <small class="text-muted">–¢–æ—á–∫–∏—Ç–µ —â–µ –±—ä–¥–∞—Ç –ø—Ä–µ—Ö–≤—ä—Ä–ª–µ–Ω–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ.</small>
              </div>
                  {% for s in all_soldiers %}
                  {% endfor %}
                </select>
              </div>

              <div class="mb-3">
                <label class="form-label">–ü—Ä–∏—á–∏–Ω–∞ (–û–ø—Ü–∏–æ–Ω–∞–ª–Ω–æ):</label>
                <input
                  type="text"
                  name="reason"
                  class="form-control"
                  placeholder="–ù–∞–ø—Ä. –í–Ω–µ–∑–∞–ø–Ω–æ —Ä–∞–∑–±–æ–ª—è–≤–∞–Ω–µ"
                />
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                –û—Ç–∫–∞–∑
              </button>
              <button type="submit" class="btn btn-danger">
                –ò–∑–≤—ä—Ä—à–∏ —Å–º—è–Ω–∞
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      function setupSwap(shiftId, soldierName, dutyName) {
        document.getElementById("swapForm").action =
          "/roster/swap/" + shiftId + "/";

        document.getElementById("swapTargetName").innerText = soldierName;
        document.getElementById("swapTargetDuty").innerText = dutyName;
      }
    </script>
    <div class="modal fade" id="soldierModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-body text-center p-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –¥–æ—Å–∏–µ...</p>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–∞–Ω–µ –Ω–∞ –º–æ–¥–∞–ª–Ω–∏—è –ø—Ä–æ–∑–æ—Ä–µ—Ü
        var soldierModalEl = document.getElementById('soldierModal');
        var bsModal = new bootstrap.Modal(soldierModalEl);
        var modalContent = soldierModalEl.querySelector('.modal-content');

        // 2. –°–ª—É—à–∞—Ç–µ–ª –∑–∞ –∫–ª–∏–∫ –≤—ä—Ä—Ö—É –í–°–Ø–ö–û –∏–º–µ (–≤ —Ç–∞–±–ª–∏—Ü–∞—Ç–∞ —Å –Ω–∞—Ä—è–¥–∏ –∏–ª–∏ –≤ —Å—Ç—Ä–æ–µ–≤–∏—è —Ä–∞–∑—Ö–æ–¥)
        document.body.addEventListener('click', function(e) {
            // –¢—ä—Ä—Å–∏–º –¥–∞–ª–∏ –µ –∫–ª–∏–∫–Ω–∞—Ç–æ –≤—ä—Ä—Ö—É –µ–ª–µ–º–µ–Ω—Ç —Å –∫–ª–∞—Å 'open-profile'
            var target = e.target.closest('.open-profile');
            
            if (target) {
                e.preventDefault(); // <--- –í–ê–ñ–ù–û: –¢–æ–≤–∞ —Å–ø–∏—Ä–∞ –≤—Ä—ä—â–∞–Ω–µ—Ç–æ –≥–æ—Ä–µ (#)
                
                var url = target.getAttribute('data-url');
                
                // –ü–æ–∫–∞–∑–≤–∞–º–µ –ø—Ä–æ–∑–æ—Ä–µ—Ü–∞
                bsModal.show();
                
                // –ó–∞—Ä–µ–∂–¥–∞–º–µ —Å—ä–¥—ä—Ä–∂–∞–Ω–∏–µ—Ç–æ –æ—Ç —Å—ä—Ä–≤—ä—Ä–∞
                fetch(url)
                    .then(response => response.text())
                    .then(html => {
                        modalContent.innerHTML = html;
                        // –°–ª–µ–¥ –∫–∞—Ç–æ –∑–∞—Ä–µ–¥–∏, —Ç—Ä—è–±–≤–∞ –¥–∞ –∞–∫—Ç–∏–≤–∏—Ä–∞–º–µ —Ñ–æ—Ä–º–∞—Ç–∞ –≤—ä—Ç—Ä–µ (–∞–∫–æ –∏–º–∞ —Ç–∞–∫–∞–≤–∞)
                        bindDutyForm();
                    })
                    .catch(err => {
                        modalContent.innerHTML = '<div class="modal-body text-danger">–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ!</div>';
                        console.error(err);
                    });
            }
        });

        // 3. –§—É–Ω–∫—Ü–∏—è –∑–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –∑–∞ –¥–æ–±–∞–≤—è–Ω–µ –Ω–∞ –Ω–∞—Ä—è–¥ (–≤—ä—Ç—Ä–µ –≤ –º–æ–¥–∞–ª–∞)
        function bindDutyForm() {
            var form = document.getElementById('dutyForm');
            if (form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault(); // –°–ø–∏—Ä–∞–º–µ –ø—Ä–µ–∑–∞—Ä–µ–∂–¥–∞–Ω–µ—Ç–æ
                    
                    var formData = new FormData(form);
                    var actionUrl = form.getAttribute('action');

                    fetch(actionUrl, {
                        method: 'POST',
                        body: formData,
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    })
                    .then(response => {
                        if (response.redirected) {
                            window.location.reload(); // –ê–∫–æ –µ —É—Å–ø–µ—à–Ω–æ -> —Ä–µ—Ñ—Ä–µ—à
                        } else {
                            return response.text(); // –ê–∫–æ –∏–º–∞ –≥—Ä–µ—à–∫–∞ -> –ø–æ–∫–∞–∂–∏ —è
                        }
                    })
                    .then(html => {
                        if (html) {
                            modalContent.innerHTML = html;
                            bindDutyForm(); // –ó–∞–∫–∞—á–∞–º–µ —Å–ª—É—à–∞—Ç–µ–ª—è –ø–∞–∫ –∑–∞ –Ω–æ–≤–∞—Ç–∞ —Ñ–æ—Ä–º–∞
                        }
                    });
                });
            }
        }

        // 4. –°–∫—Ä–∏–ø—Ç –∑–∞ –±—É—Ç–æ–Ω–∞ "–°–º—è–Ω–∞" (Emergency Swap)
        window.setupSwap = function(shiftId, soldierName, dutyName) {
            var form = document.getElementById('swapForm');
            if(form) {
                // –ü—Ä–æ–º–µ–Ω—è–º–µ URL-–∞ –Ω–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∏–Ω–∞–º–∏—á–Ω–æ
                form.action = "/roster/swap/" + shiftId + "/";
                // –°–ª–∞–≥–∞–º–µ –∏–º–µ–Ω–∞—Ç–∞ –≤ –º–æ–¥–∞–ª–∞, –∑–∞ –¥–∞ –∑–Ω–∞–µ –∫–æ–º–∞–Ω–¥–∏—Ä—ä—Ç –∫–æ–π —Å–º–µ–Ω—è
                document.getElementById('swapTargetName').innerText = soldierName;
                document.getElementById('swapTargetDuty').innerText = dutyName;
            }
        };
    });
</script>
  </body>
</html>
