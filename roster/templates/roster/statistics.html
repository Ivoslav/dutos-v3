{% extends 'roster/base.html' %}

{% block title %}–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞{% endblock %}

{% block extra_css %}
<style>
    .score-bar { height: 10px; border-radius: 5px; background-color: #e9ecef; }
    .score-fill { height: 100%; border-radius: 5px; background-color: #0d6efd; }
    .high-score { background-color: #dc3545; }
    /* –£–Ω–∏—Ñ–∏—Ü–∏—Ä–∞–Ω —Å—Ç–∏–ª –∑–∞ –±—É—Ç–æ–Ω–∞ –¥–æ—Å–∏–µ –≤ —Å–ø–∏—Å—ä—Ü–∏—Ç–µ */
    .btn-dossier { padding: 0.1rem 0.4rem; font-size: 0.75rem; }
</style>
{% endblock %}

{% block content %}
<div class="mt-4 mb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="display-6 fw-bold">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –°—Ç—Ä—É–∫—Ç—É—Ä–∞</h1>
        <a href="{% url 'daily_roster' %}" class="btn btn-outline-primary fw-bold">‚¨ÖÔ∏è –ö—ä–º –ì—Ä–∞—Ñ–∏–∫–∞</a>
    </div>

    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item"><button class="nav-link active fw-bold" id="points-tab" data-bs-toggle="tab" data-bs-target="#points">‚öñÔ∏è –¢–æ—á–∫–∏</button></li>
        <li class="nav-item"><button class="nav-link fw-bold" id="company-tab" data-bs-toggle="tab" data-bs-target="#company">üè¢ –ü–æ –†–æ—Ç–∏</button></li>
        <li class="nav-item"><button class="nav-link fw-bold" id="crews-tab" data-bs-toggle="tab" data-bs-target="#crews">üö¢ –ï–∫–∏–ø–∞–∂–∏</button></li>
        <li class="nav-item"><button class="nav-link fw-bold" id="class-tab" data-bs-toggle="tab" data-bs-target="#class">üéì –ö–ª–∞—Å–Ω–∏</button></li>
        <li class="nav-item ms-auto"><button class="nav-link fw-bold text-primary" id="actions-tab" data-bs-toggle="tab" data-bs-target="#actions">‚öôÔ∏è –î–µ–π—Å—Ç–≤–∏—è</button></li>
    </ul>
    
    <div class="tab-content bg-white p-4 border border-top-0 rounded-bottom shadow-sm">
        
        <div class="tab-pane fade show active" id="points">
            {% regroup leaderboard by rank_group.name as course_groups %}
            <div class="accordion" id="accordionPoints">
                {% for group in course_groups %}
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingPoints{{ forloop.counter }}">
                        <button class="accordion-button {% if not forloop.first %}collapsed{% endif %} fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePoints{{ forloop.counter }}">
                            {{ group.grouper }} <span class="badge bg-primary ms-2 rounded-pill">{{ group.list|length }} –¥—É—à–∏</span>
                        </button>
                    </h2>
                    <div id="collapsePoints{{ forloop.counter }}" class="accordion-collapse collapse {% if forloop.first %}show{% endif %}" data-bs-parent="#accordionPoints">
                        <div class="accordion-body p-0">
                            <table class="table table-hover table-sm align-middle mb-0">
                                <thead class="table-light"><tr><th>–ò–º–µ</th><th>–§–∞–∫. ‚Ññ</th><th class="text-center">–¢–æ—á–∫–∏</th><th style="width: 25%">–ù–∞—Ç–æ–≤–∞—Ä–µ–Ω–æ—Å—Ç</th><th class="text-end pe-3">–î–µ–π—Å—Ç–≤–∏–µ</th></tr></thead>
                                <tbody>
                                    {% for s in group.list %}
                                    <tr>
                                        <td class="fw-bold">
                                            {{ s.rank_title }} {{ s.smart_name }}
                                            {% if s.position != '–†–µ–¥–æ–≤–∏' %}
                                                <span class="badge bg-info text-dark ms-1" style="font-size: 0.7em;">{{ s.position }}</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-muted small">{{ s.faculty_number }}</td>
                                        <td class="text-center fs-6 fw-bold text-primary">{{ s.score }}</td>
                                        <td>
                                            <div class="score-bar"><div class="score-fill {% if s.score >= 15 %}high-score{% endif %}" style="width: {% if s.score > 20 %}100{% else %}{{ s.score|add:s.score|add:s.score|add:s.score|add:s.score }}%{% endif %}"></div></div>
                                        </td>
                                        <td class="text-end pe-3">
                                            <button class="btn btn-sm btn-outline-secondary open-profile" data-url="{% url 'soldier_profile' s.id %}">üë§ –î–æ—Å–∏–µ</button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="tab-pane fade" id="company">
            <div class="row g-4">
                <div class="col-md-4">
                    <div class="card border-primary h-100">
                        <div class="card-header bg-primary text-white fw-bold">‚öì 1-–≤–∞ –†–æ—Ç–∞ (–í–ú–°) <span class="badge bg-light text-dark float-end">{{ company_1|length }}</span></div>
                        <ul class="list-group list-group-flush" style="max-height: 550px; overflow-y: auto;">
                            {% for s in company_1 %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div style="line-height: 1.2;">
                                    <div class="fw-bold" style="font-size: 0.9rem;">
                                        {{ s.smart_name }}
                                        {% if s.position != '–†–µ–¥–æ–≤–∏' %}<span class="badge bg-info text-dark ms-1" style="font-size: 0.7em;">{{ s.position }}</span>{% endif %}
                                    </div>
                                    <div class="small text-muted" style="font-size: 0.75rem;">{{ s.rank_title }} &bull; {{ s.platoon }} –≤–∑–≤.</div>
                                </div>
                                <button class="btn btn-outline-secondary btn-dossier open-profile" data-url="{% url 'soldier_profile' s.id %}">–î–æ—Å–∏–µ</button>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card border-danger h-100">
                        <div class="card-header bg-danger text-white fw-bold">‚öïÔ∏è 2-—Ä–∞ –†–æ—Ç–∞ (–ú–µ–¥–∏—Ü–∏) <span class="badge bg-light text-dark float-end">{{ company_2|length }}</span></div>
                        <ul class="list-group list-group-flush" style="max-height: 550px; overflow-y: auto;">
                            {% for s in company_2 %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div style="line-height: 1.2;">
                                    <div class="fw-bold" style="font-size: 0.9rem;">
                                        {{ s.smart_name }}
                                        {% if s.position != '–†–µ–¥–æ–≤–∏' %}<span class="badge bg-info text-dark ms-1" style="font-size: 0.7em;">{{ s.position }}</span>{% endif %}
                                    </div>
                                    <div class="small text-muted" style="font-size: 0.75rem;">{{ s.rank_title }} &bull; {{ s.platoon }} –≤–∑–≤.</div>
                                </div>
                                <button class="btn btn-outline-secondary btn-dossier open-profile" data-url="{% url 'soldier_profile' s.id %}">–î–æ—Å–∏–µ</button>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card border-success h-100">
                        <div class="card-header bg-success text-white fw-bold">üë∂ –ú–ª–∞–¥–∏ –ö—É—Ä—Å–∞–Ω—Ç–∏ <span class="badge bg-light text-dark float-end">{{ young_cadets|length }}</span></div>
                        <ul class="list-group list-group-flush" style="max-height: 550px; overflow-y: auto;">
                            {% for s in young_cadets %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div style="line-height: 1.2;">
                                    <div class="fw-bold" style="font-size: 0.9rem;">
                                        {{ s.smart_name }}
                                        {% if s.position != '–†–µ–¥–æ–≤–∏' %}<span class="badge bg-info text-dark ms-1" style="font-size: 0.7em;">{{ s.position }}</span>{% endif %}
                                    </div>
                                    <div class="small text-muted" style="font-size: 0.75rem;">{{ s.rank_title }} &bull; {{ s.platoon }} –≤–∑–≤.</div>
                                </div>
                                <button class="btn btn-outline-secondary btn-dossier open-profile" data-url="{% url 'soldier_profile' s.id %}">–î–æ—Å–∏–µ</button>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="crews">
            
            <h5 class="fw-bold text-primary mb-3"><i class="bi bi-star-fill text-warning"></i> –©–ê–ë / –í–∏—Å—à –ö–æ–º–∞–Ω–¥–µ–Ω –°—ä—Å—Ç–∞–≤</h5>
            <div class="row g-3 mb-5">
                {% for s in high_command %}
                <div class="col-md-3">
                    <div class="card border-primary border-2 shadow-sm h-100 bg-light">
                        <div class="card-body p-2 d-flex justify-content-between align-items-center">
                            <div>
                                <span class="badge bg-primary text-uppercase mb-1">{{ s.position }}</span>
                                <div class="fw-bold">{{ s.smart_name }}</div>
                                <div class="small text-muted" style="font-size:0.75rem;">{{ s.rank_title }}</div>
                            </div>
                            <button class="btn btn-outline-primary btn-sm open-profile" data-url="{% url 'soldier_profile' s.id %}">üë§</button>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="col-12 text-muted small">–ù—è–º–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏ –î–ö/–û–ö –∫–æ–º–∞–Ω–¥–∏—Ä–∏.</div>
                {% endfor %}
            </div>

            <h5 class="fw-bold text-secondary mb-3"><i class="bi bi-people-fill"></i> –ï–∫–∏–ø–∞–∂–∏</h5>
            <div class="row g-3">
                {% for crew in by_crew %}
                <div class="col-md-3">
                    <div class="card h-100 border-secondary shadow-sm">
                        <div class="card-header bg-secondary text-white py-1 text-center fw-bold">{{ crew.name }}</div>
                        <ul class="list-group list-group-flush">
                            {% for s in crew.members %}
                            <li class="list-group-item px-2 py-1 d-flex justify-content-between align-items-center {% if s.position == '–ï–ö' or s.position == '–ó–ï–ö' %}bg-light{% endif %}">
                                <div style="font-size: 0.85rem;">
                                    {% if s.position != '–†–µ–¥–æ–≤–∏' %}<span class="badge bg-info text-dark me-1" style="font-size: 0.65rem;">{{ s.position }}</span>{% endif %}
                                    <span class="{% if s.position != '–†–µ–¥–æ–≤–∏' %}fw-bold{% endif %}">{{ s.smart_name }}</span>
                                    <span class="text-muted ms-1" style="font-size:0.7rem;">({{ s.rank_title|slice:":2" }}.)</span>
                                </div>
                                <button class="btn btn-outline-secondary border-0 p-0 ms-1 open-profile" data-url="{% url 'soldier_profile' s.id %}">
                                    <i class="bi bi-info-circle text-primary"></i>
                                </button>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                {% empty %}
                <div class="col-12 text-muted">–ù—è–º–∞ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–∏ –µ–∫–∏–ø–∞–∂–∏.</div>
                {% endfor %}
            </div>
        </div>

        <div class="tab-pane fade" id="class">
            <div class="row g-3">
                {% for group in by_class %}
                <div class="col-md-3">
                    <div class="card h-100 shadow-sm border-dark">
                        <div class="card-header bg-dark text-white py-1 text-center fw-bold">–ö–ª. {{ group.name }}</div>
                        <ul class="list-group list-group-flush">
                            {% for s in group.members %}
                            <li class="list-group-item px-2 py-1 d-flex justify-content-between align-items-center">
                                <div style="font-size: 0.85rem;">
                                    <span class="text-muted me-1">{{ s.faculty_number|slice:"-2:" }}</span> 
                                    {{ s.smart_name }}
                                </div>
                                <button class="btn btn-outline-secondary border-0 p-0 ms-1 open-profile" data-url="{% url 'soldier_profile' s.id %}">
                                    <i class="bi bi-info-circle text-primary"></i>
                                </button>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                {% empty %}
                <div class="col-12 text-muted">–ù—è–º–∞ –¥–∞–Ω–Ω–∏ –∑–∞ –∫–ª–∞—Å–Ω–∏ –æ—Ç–¥–µ–ª–µ–Ω–∏—è.</div>
                {% endfor %}
            </div>
        </div>

        <div class="tab-pane fade" id="actions">
            <div class="text-center py-5">
                <i class="bi bi-tools display-1 text-muted mb-3"></i>
                <h3 class="fw-bold text-muted">–†–∞–±–æ—Ç–∏–ª–Ω–∏—Ü–∞</h3>
                <p>–¢—É–∫ —â–µ —Å–ª–æ–∂–∏–º –ú–∞—Å–æ–≤–∞—Ç–∞ –æ—Ç–ø—É—Å–∫–∞, –ï–∫—Å–ø–æ—Ä—Ç–∞ –≤ Excel/PDF –∏ –†–∞–ø–æ—Ä—Ç–∏—Ç–µ.</p>
            </div>
        </div>

    </div>
</div>

<div class="modal fade" id="soldierModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content"><div class="modal-body text-center p-5"><div class="spinner-border text-primary"></div></div></div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // –õ–æ–≥–∏–∫–∞ –∑–∞ –º–æ–¥–∞–ª–Ω–∏—è –ø—Ä–æ–∑–æ—Ä–µ—Ü
        var soldierModal = new bootstrap.Modal(document.getElementById('soldierModal'));
        var modalContent = document.querySelector('#soldierModal .modal-content');

        document.body.addEventListener('click', function(e) {
            var target = e.target.closest('.open-profile');
            if (target) {
                e.preventDefault();
                soldierModal.show();
                fetch(target.getAttribute('data-url'))
                    .then(response => response.text())
                    .then(html => {
                        modalContent.innerHTML = html;
                        // –ê–∫–æ –≤—ä—Ç—Ä–µ –∏–º–∞ —Ñ–æ—Ä–º–∞ –∑–∞ –Ω–∞—Ä—è–¥, —è –∞–∫—Ç–∏–≤–∏—Ä–∞–º–µ (–∫–∞–∫—Ç–æ –≤ –≥—Ä–∞—Ñ–∏–∫–∞)
                        bindDutyForm();
                    });
            }
        });

        function bindDutyForm() {
            var form = document.getElementById('dutyForm');
            if (form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    fetch(form.action, {
                        method: 'POST',
                        body: new FormData(form),
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    })
                    .then(r => r.redirected ? window.location.reload() : r.text())
                    .then(html => { if(html) { modalContent.innerHTML = html; bindDutyForm(); } });
                });
            }
        }
    });
</script>
{% endblock %}