{% extends 'roster/base.html' %}

{% block title %}–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞{% endblock %}

{% block extra_css %}
<style>
    .score-bar { height: 10px; border-radius: 5px; background-color: #e9ecef; }
    .score-fill { height: 100%; border-radius: 5px; background-color: #0d6efd; }
    .high-score { background-color: #dc3545; }
    .soldier-row.hidden { display: none; }
    .selected-row { background-color: #e8f0fe !important; }
</style>
{% endblock %}

{% block content %}
<div class="mt-4 mb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="display-6 fw-bold">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h1>
        <a href="{% url 'daily_roster' %}" class="btn btn-outline-primary fw-bold">‚¨ÖÔ∏è –ö—ä–º –ì—Ä–∞—Ñ–∏–∫–∞</a>
    </div>

    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item"><button class="nav-link active fw-bold" id="points-tab" data-bs-toggle="tab" data-bs-target="#points">‚öñÔ∏è –¢–æ—á–∫–∏</button></li>
        <li class="nav-item"><button class="nav-link fw-bold" id="company-tab" data-bs-toggle="tab" data-bs-target="#company">üè¢ –ü–æ –†–æ—Ç–∏</button></li>
        <li class="nav-item"><button class="nav-link fw-bold text-danger" id="mass-tab" data-bs-toggle="tab" data-bs-target="#mass">‚ö° –ú–∞—Å–æ–≤–æ –û—Ç–ø—É—Å–∫–∞</button></li>
        <li class="nav-item"><button class="nav-link fw-bold" id="crews-tab" data-bs-toggle="tab" data-bs-target="#crews">üö¢ –ï–∫–∏–ø–∞–∂–∏</button></li>
        <li class="nav-item"><button class="nav-link fw-bold" id="class-tab" data-bs-toggle="tab" data-bs-target="#class">üéì –ö–ª–∞—Å–Ω–∏</button></li>
    </ul>
    
    <div class="tab-content bg-white p-4 border border-top-0 rounded-bottom shadow-sm">
        
        <div class="tab-pane fade show active" id="points">
            <div class="alert alert-info py-2 small">
                –ü–æ–∫–∞–∑–≤–∞ –≤–æ–µ–Ω–Ω–æ—Å–ª—É–∂–µ—â–∏—Ç–µ, –ø–æ–¥—Ä–µ–¥–µ–Ω–∏ –ø–æ –∫—É—Ä—Å –∏ —Ç–æ—á–∫–∏. –ù–∞–π-–Ω–∞—Ç–æ–≤–∞—Ä–µ–Ω–∏—Ç–µ —Å–∞ –Ω–∞–π-–æ—Ç–≥–æ—Ä–µ.
            </div>
            {% regroup leaderboard by rank_group.name as course_groups %}
            <div class="accordion" id="accordionPoints">
                {% for group in course_groups %}
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingPoints{{ forloop.counter }}">
                        <button class="accordion-button {% if not forloop.first %}collapsed{% endif %} fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePoints{{ forloop.counter }}">
                            {{ group.grouper }} <span class="badge bg-primary ms-2 rounded-pill">{{ group.list|length }} –¥—É—à–∏</span>
                        </button>
                    </h2>
                    <div id="collapsePoints{{ forloop.counter }}" class="accordion-collapse collapse {% if forloop.first %}show{% endif %}" data-bs-parent="#accordionPoints">
                        <div class="accordion-body p-0">
                            <table class="table table-hover table-sm align-middle mb-0">
                                <thead class="table-light"><tr><th>–ò–º–µ</th><th>–§–∞–∫. ‚Ññ</th><th class="text-center" style="width: 15%">–¢–æ—á–∫–∏</th><th style="width: 30%">–ù–∞—Ç–æ–≤–∞—Ä–µ–Ω–æ—Å—Ç</th><th></th></tr></thead>
                                <tbody>
                                    {% for s in group.list %}
                                    <tr>
                                        <tr>
                                        <td class="fw-bold">
                                            {{ s.rank_title }} {{ s.smart_name }}
                                            {% if s.position != '–†–µ–¥–æ–≤–∏' %}
                                                <span class="badge bg-info text-dark ms-1" style="font-size: 0.7em;">{{ s.position }}</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-muted">{{ s.faculty_number }}</td>
                                        <td class="text-center fs-5 fw-bold text-primary">{{ s.score }}</td>
                                        <td>
                                            <div class="score-bar"><div class="score-fill {% if s.score >= 15 %}high-score{% endif %}" style="width: {% if s.score > 20 %}100{% else %}{{ s.score|add:s.score|add:s.score|add:s.score|add:s.score }}%{% endif %}"></div></div>
                                        </td>
                                        <td class="text-end"><button class="btn btn-sm btn-outline-secondary open-profile" data-url="{% url 'soldier_profile' s.id %}">–î–æ—Å–∏–µ</button></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="tab-pane fade" id="company">
            <div class="row g-4">
                <div class="col-md-4">
                    <div class="card border-primary h-100">
                        <div class="card-header bg-primary text-white fw-bold">‚öì 1-–≤–∞ –†–æ—Ç–∞ (–í–ú–°) <span class="badge bg-light text-dark float-end">{{ company_1|length }}</span></div>
                        <ul class="list-group list-group-flush small" style="max-height: 500px; overflow-y: auto;">
                            {% for s in company_1 %}
                            <li class="list-group-item d-flex justify-content-between">
                                <span>{{ s.rank_title }} <strong>{{ s.smart_name }}</strong> ({{ s.platoon }} –≤–∑–≤.)</span>
                                <span class="badge bg-secondary rounded-pill">{{ s.score }}</span>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card border-danger h-100">
                        <div class="card-header bg-danger text-white fw-bold">‚öïÔ∏è 2-—Ä–∞ –†–æ—Ç–∞ (–ú–µ–¥–∏—Ü–∏) <span class="badge bg-light text-dark float-end">{{ company_2|length }}</span></div>
                        <ul class="list-group list-group-flush small" style="max-height: 500px; overflow-y: auto;">
                            {% for s in company_2 %}
                            <li class="list-group-item d-flex justify-content-between">
                                <span>{{ s.rank_title }} <strong>{{ s.smart_name }}</strong> ({{ s.platoon }} –≤–∑–≤.)</span>
                                <span class="badge bg-secondary rounded-pill">{{ s.score }}</span>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card border-success h-100">
                        <div class="card-header bg-success text-white fw-bold">üë∂ –ú–ª–∞–¥–∏ –ö—É—Ä—Å–∞–Ω—Ç–∏ <span class="badge bg-light text-dark float-end">{{ young_cadets|length }}</span></div>
                        <ul class="list-group list-group-flush small" style="max-height: 500px; overflow-y: auto;">
                            {% for s in young_cadets %}
                            <li class="list-group-item d-flex justify-content-between">
                                <span>{{ s.rank_title }} <strong>{{ s.smart_name }}</strong> ({{ s.company }}–†)</span>
                                <span class="badge bg-secondary rounded-pill">{{ s.score }}</span>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="mass">
            <div class="alert alert-warning">
                <strong>–í–Ω–∏–º–∞–Ω–∏–µ:</strong> –ò–∑–±–∏—Ä–∞–Ω–µ—Ç–æ –Ω–∞ —Ö–æ—Ä–∞ –∏ –∑–∞–ø–∞–∑–≤–∞–Ω–µ—Ç–æ –Ω–∞ –æ—Ç–ø—É—Å–∫–∞/–±–æ–ª–Ω–∏—á–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —â–µ –∏–∑—Ç—Ä–∏–µ –≤—Å–∏—á–∫–∏ —Ç–µ—Ö–Ω–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏ –Ω–∞—Ä—è–¥–∏ –∑–∞ –∏–∑–±—Ä–∞–Ω–∏—è –ø–µ—Ä–∏–æ–¥!
            </div>
            
            <form method="post" action="{% url 'save_batch_leave' %}">
                {% csrf_token %}
                <div class="row bg-light p-3 rounded mb-3 border align-items-end">
                    <div class="col-md-2">{{ batch_form.start_date.label_tag }}{{ batch_form.start_date }}</div>
                    <div class="col-md-2">{{ batch_form.end_date.label_tag }}{{ batch_form.end_date }}</div>
                    <div class="col-md-3">{{ batch_form.leave_type.label_tag }}{{ batch_form.leave_type }}</div>
                    <div class="col-md-3">{{ batch_form.reason.label_tag }}{{ batch_form.reason }}</div>
                    <div class="col-md-2"><button type="submit" class="btn btn-danger w-100 fw-bold">üíæ –ó–ê–ü–ò–®–ò</button></div>
                </div>

                <div class="mb-2">
                    <input type="text" id="filterCompany" class="form-control form-control-sm w-25 d-inline-block" placeholder="–§–∏–ª—Ç—ä—Ä –ø–æ –†–æ—Ç–∞ (–Ω–∞–ø—Ä. 1)">
                    <button type="button" class="btn btn-sm btn-secondary ms-2" id="selectAllBtn">–ò–∑–±–µ—Ä–∏ –≤—Å–∏—á–∫–∏ –≤–∏–¥–∏–º–∏</button>
                </div>

                <div style="max-height: 400px; overflow-y: auto; border: 1px solid #dee2e6;">
                    <table class="table table-sm table-hover mb-0" id="massTable">
                        <thead class="table-dark" style="position: sticky; top: 0; z-index: 1;">
                            <tr><th style="width: 5%">–ò–∑–±–æ—Ä</th><th>–ò–º–µ</th><th>–†–æ—Ç–∞ / –í–∑–≤–æ–¥</th><th>–ó–≤–∞–Ω–∏–µ</th></tr>
                        </thead>
                        <tbody>
                            {% for s in all_soldiers %}
                            <tr class="soldier-row" data-company="{{ s.company }}">
                                <td class="text-center">
                                    <input class="form-check-input soldier-checkbox" type="checkbox" name="selected_soldiers" value="{{ s.id }}">
                                </td>
                                <td class="fw-bold">{{ s.smart_name }}</td>
                                <td>{{ s.company }} —Ä–æ—Ç–∞ / {{ s.platoon }} –≤–∑–≤.</td>
                                <td>{{ s.rank_title }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </form>
        </div>

        <div class="tab-pane fade" id="crews">
            {% regroup by_crew by crew as crew_groups %}
            <div class="row g-3">
                {% for group in crew_groups %}
                <div class="col-md-3">
                    <div class="card h-100 border-secondary shadow-sm">
                        <div class="card-header bg-secondary text-white py-1 text-center fw-bold">{{ group.grouper }}</div>
                        <ul class="list-group list-group-flush small">
                            {% for s in group.list %}
                            <li class="list-group-item d-flex justify-content-between">
                                {{ s.smart_name }} <span class="text-muted">{{ s.rank_title }}</span>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="tab-pane fade" id="class">
            {% regroup by_class by class_section as class_groups %}
            <div class="row g-3">
                {% for group in class_groups %}
                <div class="col-md-2">
                    <div class="card h-100 shadow-sm">
                        <div class="card-header bg-dark text-white py-1 text-center fw-bold">–ö–ª. {{ group.grouper }}</div>
                        <ul class="list-group list-group-flush small" style="font-size: 0.8rem">
                            {% for s in group.list %}
                            <li class="list-group-item py-1">{{ s.faculty_number|slice:"-2:" }} {{ s.smart_name }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

    </div>
</div>

<div class="modal fade" id="soldierModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content"><div class="modal-body text-center p-5"><div class="spinner-border text-primary"></div></div></div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // –õ–æ–≥–∏–∫–∞ –∑–∞ –º–∞—Å–æ–≤–∞—Ç–∞ –æ—Ç–ø—É—Å–∫–∞
        const filterCompany = document.getElementById('filterCompany');
        const rows = document.querySelectorAll('.soldier-row');
        const selectAllBtn = document.getElementById('selectAllBtn');

        if (filterCompany) {
            filterCompany.addEventListener('input', function() {
                const val = this.value.toLowerCase();
                rows.forEach(row => {
                    const company = row.getAttribute('data-company').toLowerCase();
                    if (val === "" || company.includes(val)) {
                        row.classList.remove('hidden');
                    } else {
                        row.classList.add('hidden');
                    }
                });
            });
        }

        if (selectAllBtn) {
            selectAllBtn.addEventListener('click', function() {
                const visibleCheckboxes = document.querySelectorAll('.soldier-row:not(.hidden) .soldier-checkbox');
                const allChecked = Array.from(visibleCheckboxes).every(cb => cb.checked);
                visibleCheckboxes.forEach(cb => {
                    cb.checked = !allChecked;
                    toggleRowHighlight(cb);
                });
            });
        }

        document.querySelectorAll('.soldier-checkbox').forEach(cb => {
            cb.addEventListener('change', function() { toggleRowHighlight(this); });
        });

        function toggleRowHighlight(checkbox) {
            const row = checkbox.closest('tr');
            if (checkbox.checked) row.classList.add('selected-row');
            else row.classList.remove('selected-row');
        }

        // –ú–æ–¥–∞–ª –∑–∞ –ø—Ä–æ—Ñ–∏–ª–∏—Ç–µ
        var soldierModal = new bootstrap.Modal(document.getElementById('soldierModal'));
        var modalContent = document.querySelector('#soldierModal .modal-content');

        document.body.addEventListener('click', function(e) {
            var target = e.target.closest('.open-profile');
            if (target) {
                e.preventDefault();
                soldierModal.show();
                fetch(target.getAttribute('data-url'))
                    .then(response => response.text())
                    .then(html => {
                        modalContent.innerHTML = html;
                    });
            }
        });
    });
</script>
{% endblock %}