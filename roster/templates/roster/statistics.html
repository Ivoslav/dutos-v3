<!doctype html>
<html lang="bg">
  <head>
    <meta charset="UTF-8" />
    <title>DUTOS - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –ú–∞—Å–æ–≤–∏ –î–µ–π—Å—Ç–≤–∏—è</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
      body { background-color: #f8f9fa; }
      .score-bar { height: 10px; border-radius: 5px; background-color: #e9ecef; }
      .score-fill { height: 100%; border-radius: 5px; background-color: #0d6efd; }
      .high-score { background-color: #dc3545; }
      .soldier-row.hidden { display: none; }
      .selected-row { background-color: #e8f0fe !important; }
    </style>
  </head>
  <body>
    <div class="container mt-4 mb-5">
      
      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      {% endif %}

      <div class="d-flex justify-content-between align-items-center mb-4">
          <h1 class="display-6">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h1>
          <a href="{% url 'daily_roster' %}" class="btn btn-outline-primary">‚¨ÖÔ∏è –ö—ä–º –ì—Ä–∞—Ñ–∏–∫–∞</a>
      </div>

      <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item">
          <button class="nav-link active" id="points-tab" data-bs-toggle="tab" data-bs-target="#points" type="button">‚öñÔ∏è –¢–æ—á–∫–∏</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" id="company-tab" data-bs-toggle="tab" data-bs-target="#company" type="button">üè¢ –ü–æ –†–æ—Ç–∏</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="mass-tab" data-bs-toggle="tab" data-bs-target="#mass" type="button">‚ö° –ú–∞—Å–æ–≤–æ –û—Ç–ø—É—Å–∫–∞</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" id="crews-tab" data-bs-toggle="tab" data-bs-target="#crews" type="button">üö¢ –ï–∫–∏–ø–∞–∂–∏</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" id="class-tab" data-bs-toggle="tab" data-bs-target="#class" type="button">üéì –ö–ª–∞—Å–Ω–∏</button>
        </li>
      </ul>

      <div class="tab-content bg-white p-4 border border-top-0 rounded-bottom shadow-sm" id="myTabContent">
        
        <div class="tab-pane fade show active" id="points">
          {% regroup leaderboard by rank_group as course_groups %}

          <div class="d-flex justify-content-end mb-2">
            <button class="btn btn-outline-secondary btn-sm" onclick="toggleAllAccordions()">
              ‚ÜïÔ∏è –†–∞–∑–ø—ä–Ω–∏ / –°–≤–∏–π –≤—Å–∏—á–∫–∏
            </button>
          </div>

          <div class="accordion" id="accordionCourses">
            {% for group in course_groups %}
            <div class="card mb-3 border-secondary">
              <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center"
                style="cursor: pointer" data-bs-toggle="collapse" data-bs-target="#collapseCourse{{ forloop.counter }}">
                <h5 class="mb-0">üìÇ {{ group.grouper }}</h5>
                <span class="badge bg-light text-dark">{{ group.list|length }} –¥—É—à–∏</span>
              </div>

              <div id="collapseCourse{{ forloop.counter }}" class="accordion-collapse collapse" data-bs-parent="#accordionCourses">
                <div class="card-body p-0">
                  <table class="table table-striped table-hover mb-0">
                    <thead>
                      <tr><th style="width: 5%">#</th><th style="width: 35%">–ò–º–µ</th><th style="width: 15%">–¢–æ—á–∫–∏</th><th style="width: 45%">–ù–∞—Ç–æ–≤–∞—Ä–≤–∞–Ω–µ</th></tr>
                    </thead>
                    <tbody>
                      {% for soldier in group.list %}
                      <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>
                          <a href="#" class="text-decoration-none text-dark open-profile" data-url="{% url 'soldier_profile' soldier.id %}">
                            {{ soldier.rank_title }} <strong>{{ soldier.last_name }}</strong>
                          </a>
                          <div class="small text-muted">{{ soldier.faculty_number }}</div>
                        </td>
                        <td><strong>{{ soldier.score }}</strong></td>
                        <td class="align-middle">
                          <div class="score-bar">
                            <div class="score-fill {% if soldier.score > 20 %}high-score{% endif %}" style="width: {% widthratio soldier.score 50 100 %}%;"></div>
                          </div>
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>

        <div class="tab-pane fade" id="company">
          <div class="row">
            <div class="col-md-4 mb-3">
              <div class="card h-100 border-primary">
                <div class="card-header bg-primary text-white text-center">
                    <h5 class="mb-0">1-–≤–∞ –†–û–¢–ê</h5>
                    <span class="badge bg-light text-dark mt-1">{{ company_1|length }} –¥—É—à–∏</span>
                </div>
                <div class="table-responsive" style="max_height: 500px; overflow-y: auto;">
                  <table class="table table-hover table-sm mb-0">
                    <thead class="table-light sticky-top"><tr><th>–ó–≤–∞–Ω–∏–µ / –ò–º–µ</th><th class="text-end">–í–∑–≤–æ–¥</th></tr></thead>
                    <tbody>
                      {% for s in company_1 %}
                      <tr>
                        <td><a href="#" class="text-dark open-profile" data-url="{% url 'soldier_profile' s.id %}"><strong>{{ s.rank_title }}</strong> {{ s.last_name }}</a></td>
                        <td class="text-end"><span class="badge bg-secondary">{{ s.platoon }} –≤–∑–≤.</span></td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <div class="col-md-4 mb-3">
              <div class="card h-100 border-danger">
                <div class="card-header bg-danger text-white text-center">
                    <h5 class="mb-0">2-—Ä–∞ –†–û–¢–ê (–ú–µ–¥–∏—Ü–∏)</h5>
                    <span class="badge bg-light text-dark mt-1">{{ company_2|length }} –¥—É—à–∏</span>
                </div>
                <div class="table-responsive" style="max_height: 500px; overflow-y: auto;">
                    <table class="table table-hover table-sm mb-0">
                      <thead class="table-light sticky-top"><tr><th>–ó–≤–∞–Ω–∏–µ / –ò–º–µ</th><th class="text-end">–í–∑–≤–æ–¥</th></tr></thead>
                      <tbody>
                        {% for s in company_2 %}
                        <tr>
                          <td><a href="#" class="text-dark open-profile" data-url="{% url 'soldier_profile' s.id %}"><strong>{{ s.rank_title }}</strong> {{ s.last_name }}</a></td>
                          <td class="text-end"><span class="badge bg-secondary">{{ s.platoon }} –≤–∑–≤.</span></td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
              </div>
            </div>

            <div class="col-md-4 mb-3">
                <div class="card h-100 border-success">
                  <div class="card-header bg-success text-white text-center">
                    <h5 class="mb-0">üë∂ –ú–õ–ê–î–ò –ö–£–†–°–ê–ù–¢–ò</h5>
                    <span class="badge bg-light text-dark mt-1">{{ young_cadets|length }} –¥—É—à–∏</span>
                  </div>
                  <div class="table-responsive" style="max_height: 500px; overflow-y: auto;">
                      <table class="table table-hover table-sm mb-0">
                        <thead class="table-light sticky-top"><tr><th>–ó–≤–∞–Ω–∏–µ / –ò–º–µ</th><th class="text-end">–°—Ç–∞—Ç—É—Å</th></tr></thead>
                        <tbody>
                          {% for s in young_cadets %}
                          <tr>
                            <td><a href="#" class="text-dark open-profile" data-url="{% url 'soldier_profile' s.id %}"><strong>{{ s.rank_title }}</strong> {{ s.last_name }}</a></td>
                            <td class="text-end"><span class="badge bg-success">1-–≤–∏ –∫—É—Ä—Å</span></td>
                          </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                </div>
              </div>
          </div>
        </div>

        <div class="tab-pane fade" id="mass">
            <form method="post" action="{% url 'save_batch_leave' %}">
                {% csrf_token %}
                <div class="row g-2 mb-3 p-3 bg-light rounded border">
                    <div class="col-12 text-center text-primary fw-bold">‚ö° –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞ –º–∞—Å–æ–≤–∞—Ç–∞ –æ—Ç–ø—É—Å–∫–∞ / –Ω–∞–≥—Ä–∞–¥–∞</div>
                    <div class="col-md-3">{{ batch_form.start_date.label_tag }} {{ batch_form.start_date }}</div>
                    <div class="col-md-3">{{ batch_form.end_date.label_tag }} {{ batch_form.end_date }}</div>
                    <div class="col-md-3">{{ batch_form.leave_type.label_tag }} {{ batch_form.leave_type }}</div>
                    <div class="col-md-3">{{ batch_form.reason.label_tag }} {{ batch_form.reason }}</div>
                </div>

                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="d-flex gap-2">
                        <select id="filterCompany" class="form-select form-select-sm" style="width: 170px;">
                            <option value="all">–í—Å–∏—á–∫–∏ –†–æ—Ç–∏</option>
                            <option value="1">1-–≤–∞ –†–æ—Ç–∞ (–°—Ç–∞—Ä–∏)</option>
                            <option value="2">2-—Ä–∞ –†–æ—Ç–∞ (–ú–µ–¥–∏—Ü–∏)</option>
                            <option value="young">üë∂ –ú–ª–∞–¥–∏ –ö—É—Ä—Å–∞–Ω—Ç–∏</option> <option value="–©–∞–±">–©–∞–±</option>
                        </select>
                        <select id="filterPlatoon" class="form-select form-select-sm" style="width: 150px;">
                            <option value="all">–í—Å–∏—á–∫–∏ –í–∑–≤–æ–¥–æ–≤–µ</option>
                            <option value="1">1-–≤–∏</option>
                            <option value="2">2-—Ä–∏</option>
                            <option value="3">3-—Ç–∏</option>
                            <option value="4">4-—Ç–∏</option>
                            <option value="–ú–ª–∞–¥–∏">–ú–ª–∞–¥–∏</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-success fw-bold">üíæ –ó–∞–ø–∏—à–∏ –Ω–∞ –∏–∑–±—Ä–∞–Ω–∏—Ç–µ</button>
                </div>

                <div class="table-responsive border rounded" style="max_height: 600px; overflow-y: auto;">
                    <table class="table table-hover mb-0" id="massTable">
                        <thead class="table-dark sticky-top">
                            <tr>
                                <th style="width: 40px;"><input type="checkbox" id="selectAllVisible" class="form-check-input"></th>
                                <th>–ò–º–µ</th>
                                <th>–†–æ—Ç–∞/–í–∑–≤–æ–¥</th>
                                <th>–¢–æ—á–∫–∏</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for s in all_soldiers %}
                            <tr class="soldier-row" 
                                data-company="{% if s.platoon == '–ú–ª–∞–¥–∏' %}young{% else %}{{ s.company }}{% endif %}" 
                                data-platoon="{{ s.platoon }}">
                                <td class="text-center"><input type="checkbox" name="selected_soldiers" value="{{ s.id }}" class="form-check-input row-checkbox"></td>
                                <td>
                                    <strong>{{ s.last_name }}</strong> <small class="text-muted">({{ s.rank_title }})</small>
                                </td>
                                <td>
                                    {% if s.platoon == '–ú–ª–∞–¥–∏' %}
                                        <span class="badge bg-success">–ú–ª–∞–¥–∏</span>
                                    {% elif s.company == '1' %}
                                        <span class="badge bg-primary">1-–≤–∞</span>
                                    {% elif s.company == '2' %}
                                        <span class="badge bg-danger">2-—Ä–∞</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ s.company }}</span>
                                    {% endif %}
                                    / {{ s.platoon }} –≤–∑–≤.
                                </td>
                                <td>{{ s.score }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="text-end mt-2 small text-muted">–ü–æ–∫–∞–∑–∞–Ω–∏ <span id="visibleCount">{{ all_soldiers|length }}</span> –¥—É—à–∏</div>
            </form>
        </div>

        <div class="tab-pane fade" id="crews">
          {% regroup by_crew by crew as crew_list %}
          <div class="row">
            {% for crew in crew_list %}
            <div class="col-md-4 mb-3">
              <div class="card border-primary h-100">
                <div class="card-header bg-primary text-white">–ï–∫–∏–ø–∞–∂: {{ crew.grouper }}</div>
                <ul class="list-group list-group-flush">
                  {% for s in crew.list %}
                  <li class="list-group-item">{{ s.rank_title }} {{ s.last_name }}</li>
                  {% endfor %}
                </ul>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>

        <div class="tab-pane fade" id="class">
          {% regroup by_class by class_section as class_list %}
          <div class="accordion" id="accordionClass">
            {% for section in class_list %}
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCl{{ forloop.counter }}">
                  –ö–ª–∞—Å–Ω–æ: {{ section.grouper }} ({{ section.list|length }} –¥—É—à–∏)
                </button>
              </h2>
              <div id="collapseCl{{ forloop.counter }}" class="accordion-collapse collapse" data-bs-parent="#accordionClass">
                <div class="accordion-body">
                  <table class="table table-sm">
                    <thead><tr><th>–§–∞–∫. ‚Ññ</th><th>–ò–º–µ</th><th>–¢–æ—á–∫–∏</th></tr></thead>
                    <tbody>
                      {% for s in section.list %}
                      <tr><td>{{ s.faculty_number }}</td><td>{{ s.last_name }}</td><td>{{ s.score }}</td></tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>

      </div>
    </div>

    <div class="modal fade" id="soldierModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-body text-center p-5"><div class="spinner-border text-primary"></div></div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // --- Filtering Logic ---
        const filterCompany = document.getElementById('filterCompany');
        const filterPlatoon = document.getElementById('filterPlatoon');
        const rows = document.querySelectorAll('.soldier-row');
        const selectAll = document.getElementById('selectAllVisible');
        const visibleCountSpan = document.getElementById('visibleCount');

        function filterTable() {
            const cVal = filterCompany.value;
            const pVal = filterPlatoon.value;
            let count = 0;
            rows.forEach(row => {
                const rComp = row.getAttribute('data-company');
                const rPlat = row.getAttribute('data-platoon');
                let show = true;
                if (cVal !== 'all' && cVal !== rComp) show = false;
                if (pVal !== 'all' && pVal !== rPlat) show = false;
                
                if (show) { row.classList.remove('hidden'); count++; }
                else { row.classList.add('hidden'); row.querySelector('.row-checkbox').checked = false; row.classList.remove('selected-row'); }
            });
            visibleCountSpan.textContent = count;
            selectAll.checked = false;
        }
        filterCompany.addEventListener('change', filterTable);
        filterPlatoon.addEventListener('change', filterTable);

        // Select All Logic
        selectAll.addEventListener('change', function() {
            const isChecked = this.checked;
            rows.forEach(row => {
                if (!row.classList.contains('hidden')) {
                    row.querySelector('.row-checkbox').checked = isChecked;
                    if(isChecked) row.classList.add('selected-row'); else row.classList.remove('selected-row');
                }
            });
        });
        
        // Row Highlight Logic
        document.querySelectorAll('.row-checkbox').forEach(cb => {
            cb.addEventListener('change', function() {
                if(this.checked) this.closest('tr').classList.add('selected-row');
                else this.closest('tr').classList.remove('selected-row');
            });
        });

        // Profile Modal Logic
        var soldierModal = new bootstrap.Modal(document.getElementById("soldierModal"));
        var modalContent = document.querySelector("#soldierModal .modal-content");

        document.body.addEventListener("click", function (e) {
          var target = e.target.closest(".open-profile");
          if (target) {
            e.preventDefault();
            soldierModal.show();
            fetch(target.getAttribute("data-url"))
              .then(res => res.text())
              .then(html => {
                  modalContent.innerHTML = html;
                  // Re-bind form submission if exists inside modal
                  var form = document.getElementById("dutyForm");
                  if(form) {
                      form.addEventListener("submit", function(ev){
                          ev.preventDefault();
                          fetch(form.action, {method:'POST', body: new FormData(form), headers:{'X-Requested-With':'XMLHttpRequest'}})
                          .then(r => r.redirected ? window.location.reload() : r.text())
                          .then(h => { if(h) modalContent.innerHTML = h; });
                      });
                  }
              });
          }
        });
      });
    </script>
  </body>
</html>