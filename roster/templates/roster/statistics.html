<!doctype html>
<html lang="bg">
  <head>
    <meta charset="UTF-8" />
    <title>DUTOS - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –ì—Ä—É–ø–∏</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
      body {
        background-color: #f8f9fa;
      }
      .score-bar {
        height: 10px;
        border-radius: 5px;
        background-color: #e9ecef;
      }
      .score-fill {
        height: 100%;
        border-radius: 5px;
        background-color: #0d6efd;
      }
      .high-score {
        background-color: #dc3545;
      }
    </style>
  </head>
  <body>
    <div class="container mt-4">
      <h1 class="display-6 text-center mb-4">üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ –ù–∞—Ç–æ–≤–∞—Ä–≤–∞–Ω–µ</h1>

      <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item">
          <button
            class="nav-link active"
            id="points-tab"
            data-bs-toggle="tab"
            data-bs-target="#points"
            type="button"
          >
            ‚öñÔ∏è –ù–∞—Ä—è–¥–Ω–∏ –¢–æ—á–∫–∏
          </button>
        </li>
        <li class="nav-item">
          <button
            class="nav-link"
            id="company-tab"
            data-bs-toggle="tab"
            data-bs-target="#company"
            type="button"
          >
            üè¢ –ü–æ –†–æ—Ç–∏
          </button>
        </li>
        <li class="nav-item">
          <button
            class="nav-link"
            id="crews-tab"
            data-bs-toggle="tab"
            data-bs-target="#crews"
            type="button"
          >
            üö¢ –ï–∫–∏–ø–∞–∂–∏
          </button>
        </li>
        <li class="nav-item">
          <button
            class="nav-link"
            id="class-tab"
            data-bs-toggle="tab"
            data-bs-target="#class"
            type="button"
          >
            üéì –ö–ª–∞—Å–Ω–∏
          </button>
        </li>
      </ul>

      <div
        class="tab-content bg-white p-4 border border-top-0 rounded-bottom"
        id="myTabContent"
      >
        <div class="tab-pane fade show active" id="points">
          {% regroup leaderboard by rank_group as course_groups %}

          <div class="d-flex justify-content-end mb-2">
            <button
              class="btn btn-outline-secondary btn-sm"
              onclick="toggleAllAccordions()"
            >
              ‚ÜïÔ∏è –†–∞–∑–ø—ä–Ω–∏ / –°–≤–∏–π –≤—Å–∏—á–∫–∏
            </button>
          </div>

          <div class="accordion" id="accordionCourses">
            {% for group in course_groups %}
            <div class="card mb-3 border-secondary">
              <div
                class="card-header bg-secondary text-white d-flex justify-content-between align-items-center"
                style="cursor: pointer"
                data-bs-toggle="collapse"
                data-bs-target="#collapseCourse{{ forloop.counter }}"
              >
                <h5 class="mb-0">
                  <span class="me-2">üìÇ</span> {{ group.grouper }}
                </h5>
                <div>
                  <span class="badge bg-light text-dark me-2"
                    >{{ group.list|length }} —á–æ–≤–µ–∫–∞</span
                  >
                  <small>‚ñº</small>
                </div>
              </div>

              <div
                id="collapseCourse{{ forloop.counter }}"
                class="accordion-collapse collapse"
                data-bs-parent="#accordionCourses"
              >
                <div class="card-body p-0">
                  <table class="table table-striped table-hover mb-0">
                    <thead>
                      <tr>
                        <th style="width: 5%">#</th>
                        <th style="width: 35%">–ò–º–µ</th>
                        <th style="width: 15%">–¢–æ—á–∫–∏</th>
                        <th style="width: 45%">–ù–∞—Ç–æ–≤–∞—Ä–≤–∞–Ω–µ</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for soldier in group.list %}
                      <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>
                          <a
                            href="#"
                            class="text-decoration-none text-dark open-profile"
                            data-url="{% url 'soldier_profile' soldier.id %}"
                          >
                            {{ soldier.rank_title }}
                            <strong>{{ soldier.last_name }}</strong>
                          </a>
                          <div
                            class="small text-muted"
                            style="font-size: 0.8em"
                          >
                            {{ soldier.faculty_number }}
                          </div>
                        </td>
                        <td><strong>{{ soldier.score }}</strong></td>
                        <td class="align-middle">
                          <div class="score-bar">
                            <div
                              class="score-fill {% if soldier.score > 20 %}high-score{% endif %}"
                              style="width: {% widthratio soldier.score 50 100 %}%;"
                            ></div>
                          </div>
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>

        <script>
          function toggleAllAccordions() {
            var allCollapses = document.querySelectorAll(".accordion-collapse");
            var isAnyOpen = false;

            allCollapses.forEach((el) => {
              if (el.classList.contains("show")) isAnyOpen = true;
            });

            allCollapses.forEach((el) => {
              var bsCollapse = new bootstrap.Collapse(el, { toggle: false });
              if (isAnyOpen) {
                bsCollapse.hide();
              } else {
                bsCollapse.show();
              }
            });
          }
        </script>

        <div class="tab-pane fade" id="company">
          <div class="row">
            <div class="col-md-4 mb-3">
              <div class="card h-100 shadow-sm border-primary">
                <div class="card-header bg-primary text-white text-center">
                  <h5 class="mb-0">1-–≤–∞ –†–û–¢–ê</h5>
                  <span class="badge bg-light text-dark mt-1"
                    >{{ company_1|length }} –¥—É—à–∏</span
                  >
                </div>
                <div class="table-responsive">
                  <table
                    class="table table-hover table-sm mb-0"
                    style="font-size: 0.85rem"
                  >
                    <thead class="table-light">
                      <tr>
                        <th>–ó–≤–∞–Ω–∏–µ / –ò–º–µ</th>
                        <th class="text-end">–í–∑–≤–æ–¥</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for s in company_1 %}
                      <tr>
                        <td>
                          <a
                            href="#"
                            class="text-decoration-none text-dark open-profile"
                            data-url="{% url 'soldier_profile' s.id %}"
                          >
                            <strong>{{ s.rank_title }}</strong> {{ s.last_name
                            }}
                          </a>
                          <div class="small text-muted">
                            {{ s.faculty_number }}
                          </div>
                        </td>
                        <td class="text-end align-middle">
                          <span class="badge bg-secondary"
                            >{{ s.platoon }} –æ—Ç—Ä—è–¥</span
                          >
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <div class="col-md-4 mb-3">
              <div class="card h-100 shadow-sm border-danger">
                <div class="card-header bg-danger text-white text-center">
                  <h5 class="mb-0">2-—Ä–∞ –†–û–¢–ê (–ú–µ–¥–∏—Ü–∏)</h5>
                  <span class="badge bg-light text-dark mt-1"
                    >{{ company_2|length }} –¥—É—à–∏</span
                  >
                </div>
                <div class="table-responsive">
                  <table
                    class="table table-hover table-sm mb-0"
                    style="font-size: 0.85rem"
                  >
                    <thead class="table-light">
                      <tr>
                        <th>–ó–≤–∞–Ω–∏–µ / –ò–º–µ</th>
                        <th class="text-end">–í–∑–≤–æ–¥</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for s in company_2 %}
                      <tr>
                        <td>
                          <a
                            href="#"
                            class="text-decoration-none text-dark open-profile"
                            data-url="{% url 'soldier_profile' s.id %}"
                          >
                            <strong>{{ s.rank_title }}</strong> {{ s.last_name
                            }}
                          </a>
                          <div class="small text-muted">
                            {{ s.faculty_number }}
                          </div>
                        </td>
                        <td class="text-end align-middle">
                          <span class="badge bg-secondary"
                            >{{ s.platoon }} –æ—Ç—Ä—è–¥</span
                          >
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <div class="col-md-4 mb-3">
              <div class="card h-100 shadow-sm border-success">
                <div class="card-header bg-success text-white text-center">
                  <h5 class="mb-0">üë∂ –ú–õ–ê–î–ò –ö–£–†–°–ê–ù–¢–ò</h5>
                  <span class="badge bg-light text-dark mt-1"
                    >{{ young_cadets|length }} –¥—É—à–∏</span
                  >
                </div>
                <div class="table-responsive">
                  <table
                    class="table table-hover table-sm mb-0"
                    style="font-size: 0.85rem"
                  >
                    <thead class="table-light">
                      <tr>
                        <th>–ó–≤–∞–Ω–∏–µ / –ò–º–µ</th>
                        <th class="text-end">–°—Ç–∞—Ç—É—Å</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for s in young_cadets %}
                      <tr>
                        <td>
                          <a
                            href="#"
                            class="text-decoration-none text-dark open-profile"
                            data-url="{% url 'soldier_profile' s.id %}"
                          >
                            <strong>{{ s.rank_title }}</strong> {{ s.last_name
                            }}
                          </a>
                          <div class="small text-muted">
                            {{ s.faculty_number }}
                          </div>
                        </td>
                        <td class="text-end align-middle">
                          <span class="badge bg-secondary">1-–≤–∏ –∫—É—Ä—Å</span>
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="tab-pane fade" id="crews">
          {% regroup by_crew by crew as crew_list %} {% if crew_list %}
          <div class="row">
            {% for crew in crew_list %}
            <div class="col-md-4 mb-3">
              <div class="card border-primary h-100">
                <div class="card-header bg-primary text-white">
                  –ï–∫–∏–ø–∞–∂: {{ crew.grouper }}
                </div>
                <ul class="list-group list-group-flush">
                  {% for s in crew.list %}
                  <li class="list-group-item">
                    {{ s.rank_title }} {{ s.last_name }}
                  </li>
                  {% endfor %}
                </ul>
              </div>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div class="alert alert-info">–ù—è–º–∞ –≤—ä–≤–µ–¥–µ–Ω–∏ –¥–∞–Ω–Ω–∏ –∑–∞ –µ–∫–∏–ø–∞–∂–∏.</div>
          {% endif %}
        </div>

        <div class="tab-pane fade" id="class">
          {% regroup by_class by class_section as class_list %}

          <div class="accordion" id="accordionClass">
            {% for section in class_list %}
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button
                  class="accordion-button collapsed"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#collapse{{ forloop.counter }}"
                >
                  –ö–ª–∞—Å–Ω–æ: {{ section.grouper }} ({{ section.list|length }} –¥—É—à–∏)
                </button>
              </h2>
              <div
                id="collapse{{ forloop.counter }}"
                class="accordion-collapse collapse"
                data-bs-parent="#accordionClass"
              >
                <div class="accordion-body">
                  <table class="table table-sm">
                    <thead>
                      <tr>
                        <th>–§–∞–∫. ‚Ññ</th>
                        <th>–ò–º–µ</th>
                        <th>–¢–æ—á–∫–∏</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for s in section.list %}
                      <tr>
                        <td>{{ s.faculty_number }}</td>
                        <td>{{ s.last_name }}</td>
                        <td>{{ s.score }}</td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
      <div class="text-center mt-4">
        <a href="/roster/" class="btn btn-outline-secondary"
          >‚¨ÖÔ∏è –û–±—Ä–∞—Ç–Ω–æ –∫—ä–º –ì—Ä–∞—Ñ–∏–∫–∞</a
        >
      </div>
    </div>

    <div class="modal fade" id="soldierModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-body text-center p-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p>–ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –¥–æ—Å–∏–µ...</p>
          </div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        var soldierModal = document.getElementById("soldierModal");
        var modalContent = soldierModal.querySelector(".modal-content");
        var bsModal = new bootstrap.Modal(soldierModal);

        function bindForm() {
          var form = document.getElementById("dutyForm");
          if (form) {
            form.addEventListener("submit", function (e) {
              e.preventDefault();

              var formData = new FormData(form);
              var actionUrl = form.getAttribute("action");

              fetch(actionUrl, {
                method: "POST",
                body: formData,
                headers: {
                  "X-Requested-With": "XMLHttpRequest",
                },
              })
                .then((response) => {
                  if (response.redirected) {
                    window.location.reload();
                  } else {
                    return response.text();
                  }
                })
                .then((html) => {
                  if (html) {
                    modalContent.innerHTML = html;
                    bindForm(); 
                  }
                })
                .catch((error) => {
                  console.error("Error:", error);
                  modalContent.innerHTML =
                    '<div class="modal-body text-danger">–í—ä–∑–Ω–∏–∫–Ω–∞ —Å–∏—Å—Ç–µ–º–Ω–∞ –≥—Ä–µ—à–∫–∞.</div>';
                });
            });
          }
        }

        document.body.addEventListener("click", function (e) {
          var target = e.target.closest(".open-profile");

          if (target) {
            e.preventDefault();
            var url = target.getAttribute("data-url");

            bsModal.show();

            fetch(url)
              .then((response) => response.text())
              .then((html) => {
                modalContent.innerHTML = html;
                bindForm(); 
              })
              .catch((err) => {
                modalContent.innerHTML =
                  '<div class="modal-body text-danger">–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ!</div>';
              });
          }
        });

        window.toggleAllAccordions = function () {
          var allCollapses = document.querySelectorAll(".accordion-collapse");
          var isAnyOpen = false;
          allCollapses.forEach((el) => {
            if (el.classList.contains("show")) isAnyOpen = true;
          });
          allCollapses.forEach((el) => {
            var bsCollapse = new bootstrap.Collapse(el, { toggle: false });
            if (isAnyOpen) bsCollapse.hide();
            else bsCollapse.show();
          });
        };
      });
    </script>
  </body>
</html>
