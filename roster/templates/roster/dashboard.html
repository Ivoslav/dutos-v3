{% extends 'roster/base.html' %}

{% block content %}
<div class="container-fluid py-3">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-dark mb-0">‚öì –ö–û–ú–ê–ù–î–ï–ù –ü–£–õ–¢</h2>
            <p class="text-muted mb-0">–í–í–ú–£ "–ù. –ô. –í–∞–ø—Ü–∞—Ä–æ–≤" ‚Ä¢ {{ today|date:"l, d F Y" }}</p>
        </div>
        <div>
            <a href="{% url 'debug_panel' %}" class="btn btn-warning fw-bold shadow-sm">üõ†Ô∏è –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏</a>
            <a href="{% url 'daily_roster' %}" class="btn btn-primary fw-bold shadow-sm">üìã –ü—ä–ª–µ–Ω –ì—Ä–∞—Ñ–∏–∫</a>
        </div>
    </div>
    {% if active_alert %}
<div class="alert alert-danger border-danger border-3 shadow mb-4" role="alert">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h3 class="alert-heading fw-bold mb-1">üö® {{ active_alert.title }}</h3>
            <p class="mb-0 fs-5">{{ active_alert.message }}</p>
            <small class="text-muted">{{ active_alert.created_at|date:"d.m.Y H:i" }}</small>
        </div>
        {% if user.is_superuser %}
        <form action="{% url 'dismiss_announcement' %}" method="post">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger fw-bold">üîï –û–¢–ú–ï–ù–ò</button>
        </form>
        {% endif %}
    </div>
</div>
{% endif %}

    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100 border-start border-5 border-success">
                <div class="card-body">
                    <h6 class="text-uppercase text-muted small">–°—Ç—Ä–æ–µ–≤–∏ —Å—ä—Å—Ç–∞–≤</h6>
                    <div class="d-flex align-items-baseline">
                        <h1 class="display-5 fw-bold text-success mb-0">{{ present_count }}</h1>
                        <span class="text-muted ms-2">/ {{ total_soldiers }}</span>
                    </div>
                    <small class="text-success">‚úÖ –ù–∞–ª–∏—Ü–µ –≤ –º–æ–º–µ–Ω—Ç–∞</small>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100 border-start border-5 border-primary">
                <div class="card-body">
                    <h6 class="text-uppercase text-muted small">–í –ù–∞—Ä—è–¥</h6>
                    <h1 class="display-5 fw-bold text-primary mb-0">{{ on_duty_today_count }}</h1>
                    <small class="text-primary">üõ°Ô∏è –ò–∑–ø—ä–ª–Ω—è–≤–∞—Ç —Å–ª—É–∂–±–∞</small>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100 border-start border-5 border-warning">
                <div class="card-body">
                    <h6 class="text-uppercase text-muted small">–û—Ç—Å—ä—Å—Ç–≤–∞—â–∏</h6>
                    <h1 class="display-5 fw-bold text-warning mb-0">{{ on_leave_today_count }}</h1>
                    <small class="text-muted">üè† –û—Ç–ø—É—Å–∫ / –ö–æ–º–∞–Ω–¥–∏—Ä–æ–≤–∫–∞</small>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100 border-start border-5 border-{{ tomorrow_class }}">
                <div class="card-body">
                    <h6 class="text-uppercase text-muted small">–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç –∑–∞ –£—Ç—Ä–µ</h6>
                    <h3 class="fw-bold text-{{ tomorrow_class }} mb-0 mt-2">{{ tomorrow_status }}</h3>
                    {% if not is_tomorrow_ready %}
                    <form method="post" action="{% url 'debug_panel' %}" class="mt-2">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="generate_tomorrow">
                        <button type="submit" class="btn btn-sm btn-outline-danger w-100">‚ö° –ì–µ–Ω–µ—Ä–∏—Ä–∞–π –°–µ–≥–∞</button>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        
        <div class="col-md-8">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white fw-bold border-bottom">
                    üëÆ –ö–ª—é—á–æ–≤–∏ —Ñ–∏–≥—É—Ä–∏ –Ω–∞ –¥–ª—ä–∂–Ω–æ—Å—Ç –¥–Ω–µ—Å
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>–ù–∞—Ä—è–¥</th>
                                <th>–í–æ–µ–Ω–Ω–æ—Å–ª—É–∂–µ—â</th>
                                <th>–†–æ—Ç–∞/–í–∑–≤–æ–¥</th>
                                <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for shift in key_shifts_today %}
                            <tr>
                                <td><span class="badge bg-dark">{{ shift.duty_type.name }}</span></td>
                                <td>
                                    <div class="fw-bold">{{ shift.soldier.rank_title }} {{ shift.soldier.last_name }}</div>
                                </td>
                                <td class="text-muted small">
                                    {{ shift.soldier.company }} —Ä–æ—Ç–∞ / {{ shift.soldier.platoon }} –≤–∑–≤.
                                </td>
                                <td>
                                    <a href="#" class="btn btn-sm btn-outline-secondary open-profile" 
                                       data-url="{% url 'soldier_profile' shift.soldier.id %}">üë§ –î–æ—Å–∏–µ</a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="4" class="text-center py-4 text-muted">–ù—è–º–∞ –¥–∞–Ω–Ω–∏ –∑–∞ –¥–Ω–µ—Å.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="card-footer bg-white text-center">
                    <a href="{% url 'daily_roster' %}" class="text-decoration-none">–í–∏–∂ –ø—ä–ª–Ω–∏—è —Ä–∞–∑—Ö–æ–¥ –∑–∞ –¥–µ–Ω—è &rarr;</a>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            
    
    <div class="card shadow-sm border-0 mb-4 {% if active_alert %}bg-secondary text-white{% else %}bg-danger text-white{% endif %}">
        <div class="card-body">
            <h5 class="fw-bold mb-3">
                {% if active_alert %}üì° –ê–ö–¢–ò–í–ù–û –û–ü–û–í–ï–°–¢–Ø–í–ê–ù–ï{% else %}üì¢ –ò–ó–í–™–ù–†–ï–î–ù–û –ò–ó–í–ï–°–¢–Ø–í–ê–ù–ï{% endif %}
            </h5>
            
            {% if not active_alert %}
                <form action="{% url 'post_announcement' %}" method="post">
                    {% csrf_token %}
                    <div class="mb-2">
                        <input type="text" name="title" class="form-control form-control-sm mb-2" placeholder="–ó–∞–≥–ª–∞–≤–∏–µ (–Ω–∞–ø—Ä. –°–ë–û–†)" required>
                        <textarea name="message" class="form-control form-control-sm" rows="2" placeholder="–¢–µ–∫—Å—Ç –Ω–∞ —Å—ä–æ–±—â–µ–Ω–∏–µ—Ç–æ..." required></textarea>
                    </div>
                    <button type="submit" class="btn btn-light text-danger fw-bold w-100">üöÄ –ü–£–°–ù–ò –°–™–û–ë–©–ï–ù–ò–ï</button>
                </form>
                <div class="mt-2 text-center">
                    <a href="{% url 'emergency_print' %}" target="_blank" class="text-white small text-decoration-underline">–ò–ª–∏ –ø—Ä–∏–Ω—Ç–∏—Ä–∞–π —Å–ø–∏—Å—ä–∫ —Å —Ç–µ–ª–µ—Ñ–æ–Ω–∏</a>
                </div>
            {% else %}
                <p class="small opacity-75">–í –º–æ–º–µ–Ω—Ç–∞ –∏–º–∞ –∞–∫—Ç–∏–≤–Ω–æ —Å—ä–æ–±—â–µ–Ω–∏–µ –Ω–∞ –µ–∫—Ä–∞–Ω–∏—Ç–µ –Ω–∞ –≤—Å–∏—á–∫–∏ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏.</p>
                <form action="{% url 'dismiss_announcement' %}" method="post">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-light text-dark fw-bold w-100">üîï –°–ü–†–ò –û–ü–û–í–ï–°–¢–Ø–í–ê–ù–ï–¢–û</button>
                </form>
            {% endif %}
        </div>
    </div>
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white fw-bold text-danger border-bottom">
                    ü§í –ë–æ–ª–Ω–∏ / –í –õ–∞–∑–∞—Ä–µ—Ç
                </div>
                <ul class="list-group list-group-flush">
                    {% for leave in sick_today %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>{{ leave.soldier.last_name }}</strong>
                            <div class="small text-muted">{{ leave.reason|default:"–ó–∞–±–æ–ª—è–≤–∞–Ω–µ" }}</div>
                        </div>
                        <span class="badge bg-danger rounded-pill">{{ leave.soldier.company }} —Ä–æ—Ç–∞</span>
                    </li>
                    {% empty %}
                    <li class="list-group-item text-center text-muted py-3">–ù—è–º–∞ –±–æ–ª–Ω–∏ –¥–Ω–µ—Å. ‚úÖ</li>
                    {% endfor %}
                </ul>
            </div>

        </div>
    </div>
</div>

<div class="modal fade" id="soldierModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-body text-center p-5"><div class="spinner-border text-primary"></div></div>
        </div>
    </div>
</div>

<script>
// –ö–æ–ø–∏—Ä–∞–º–µ —Å–∫—Ä–∏–ø—Ç–∞ –∑–∞ –º–æ–¥–∞–ª–Ω–∏—è –ø—Ä–æ–∑–æ—Ä–µ—Ü, –∑–∞ –¥–∞ —Ä–∞–±–æ—Ç–∏ –∏ —Ç—É–∫
document.addEventListener("DOMContentLoaded", function() {
    var soldierModal = new bootstrap.Modal(document.getElementById("soldierModal"));
    var modalContent = document.querySelector("#soldierModal .modal-content");

    document.body.addEventListener("click", function (e) {
        var target = e.target.closest(".open-profile");
        if (target) {
            e.preventDefault();
            soldierModal.show();
            fetch(target.getAttribute("data-url"))
                .then(res => res.text())
                .then(html => { modalContent.innerHTML = html; });
        }
    });
});
</script>
{% endblock %}